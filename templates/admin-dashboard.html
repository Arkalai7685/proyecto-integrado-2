{% extends 'base.html' %}
{% load static %}

{% block title %}Panel Administrador - ImpulsaMente{% endblock %}

{% block body_class %}admin-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-dashboard.css' %}">
{% endblock %}

{% block content %}
<main class="admin-dashboard-main">
    <div class="container">
        <h1 class="dashboard-title">üõ†Ô∏è Panel de Administraci√≥n</h1>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab-btn" data-tab="solicitudes">üìã Solicitudes</button>
            <button class="admin-tab-btn active" data-tab="precios">üìä Precios</button>
            <button class="admin-tab-btn" data-tab="empleados">üë• Empleados</button>
            <button class="admin-tab-btn" data-tab="clientes">üë§ Clientes</button>
            <button class="admin-tab-btn" data-tab="asignaciones">üîó Asignaciones</button>
            <button class="admin-tab-btn" data-tab="sesiones">üìÖ Sesiones</button>
            <button class="admin-tab-btn" data-tab="archivos">üìÅ Archivos</button>
            <button class="admin-tab-btn" data-tab="auditoria">üîç Auditor√≠a</button>
            <button class="admin-tab-btn" data-tab="panel-empleado">üìã Panel Empleado</button>
        </div>

        <!-- Tab Content -->
        <div class="admin-tab-content">
            <!-- SOLICITUDES TAB -->
            <div class="tab-panel active" id="solicitudes-tab">
                <div class="panel-header">
                    <h2>üìã Nuevas Solicitudes de Asesor√≠a</h2>
                    <span class="badge" style="background: #ff6b6b; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">
                        {{ orders|length }} solicitudes
                    </span>
                </div>

                {% if orders %}
                <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üí°</span>
                        <div>
                            <strong style="color: #1976D2;">Importante:</strong>
                            <p style="margin: 5px 0 0 0; color: #555; font-size: 0.9rem;">
                                Para que los clientes aparezcan en la pesta√±a "Clientes", debes <strong>generar las sesiones</strong> haciendo clic en el bot√≥n "Generar Sesiones" de cada solicitud confirmada.
                                Esto crear√° autom√°ticamente una cuenta de usuario para el cliente.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="solicitudes-container" style="display: grid; gap: 20px;">
                    {% for order in orders %}
                    <div class="solicitud-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid {% if order.status == 'pending' %}#ff8c42{% elif order.status == 'confirmed' %}#4CAF50{% else %}#999{% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 2rem;">
                                        {% if order.service.slug == 'tutoria' %}üìö
                                        {% elif order.service.slug == 'terapia' %}üß†
                                        {% elif order.service.slug == 'plan-estudiante' %}üéì
                                        {% else %}üìÑ{% endif %}
                                    </span>
                                    <div>
                                        <h3 style="margin: 0; color: #333;">{{ order.customer.name }}</h3>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">{{ order.customer.email }}</p>
                                    </div>
                                </div>
                                <span class="badge" style="background: {% if order.status == 'pending' %}#fff3cd{% elif order.status == 'confirmed' %}#d4edda{% else %}#e9ecef{% endif %}; color: {% if order.status == 'pending' %}#856404{% elif order.status == 'confirmed' %}#155724{% else %}#666{% endif %}; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">
                                    {% if order.status == 'pending' %}‚è≥ Pendiente
                                    {% elif order.status == 'confirmed' %}‚úÖ Confirmado
                                    {% elif order.status == 'in_progress' %}üîÑ En Progreso
                                    {% elif order.status == 'completed' %}‚úîÔ∏è Completado
                                    {% elif order.status == 'cancelled' %}‚ùå Cancelado
                                    {% else %}{{ order.status }}{% endif %}
                                </span>
                            </div>
                            <div style="text-align: right; color: #999; font-size: 0.85rem;">
                                <div>Hace {{ order.created_at|timesince }}</div>
                                <div style="margin-top: 5px;">Orden #{{ order.id }}</div>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Servicio</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.service.name }}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Plan</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.price.plan }}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Precio</div>
                                    <div style="font-weight: 600; color: #4CAF50;">${{ order.price.price|floatformat:0 }}</div>
                                </div>
                            </div>
                        </div>

                        {% if order.service.slug == 'plan-estudiante' %}
                        <!-- Informaci√≥n espec√≠fica de Plan Estudiante -->
                        <div style="background: #e8f5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 1rem;">üéì Plan Estudiante</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px;">üìö Tutor√≠a</div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Tutor:</strong> {{ order.preferred_tutor.get_full_name|default:order.preferred_tutor.username }}
                                    </div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Inicio:</strong> {{ order.tutoring_start_date|date:"d/m/Y" }}
                                    </div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Hora:</strong> {{ order.tutoring_time|time:"H:i" }}
                                    </div>
                                    <div style="font-size: 0.9rem;">
                                        <strong>Sesiones:</strong> {{ order.tutoring_sessions }}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #ff9800; margin-bottom: 8px;">üß† Terapia</div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Terapeuta:</strong> {{ order.preferred_therapist.get_full_name|default:order.preferred_therapist.username }}
                                    </div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Inicio:</strong> {{ order.therapy_start_date|date:"d/m/Y" }}
                                    </div>
                                    <div style="font-size: 0.9rem; margin-bottom: 4px;">
                                        <strong>Hora:</strong> {{ order.therapy_time|time:"H:i" }}
                                    </div>
                                    <div style="font-size: 0.9rem;">
                                        <strong>Sesiones:</strong> {{ order.therapy_sessions }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Informaci√≥n de servicios individuales -->
                        {% if order.preferred_employee %}
                        <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Empleado Asignado</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.preferred_employee.get_full_name|default:order.preferred_employee.username }}</div>
                                </div>
                                {% if order.start_date %}
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Fecha de Inicio</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.start_date|date:"d/m/Y" }}</div>
                                </div>
                                {% endif %}
                                {% if order.preferred_time %}
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Hora Preferida</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.preferred_time|time:"H:i" }}</div>
                                </div>
                                {% endif %}
                                {% if order.number_of_sessions %}
                                <div>
                                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">Sesiones</div>
                                    <div style="font-weight: 600; color: #333;">{{ order.number_of_sessions }}</div>
                                </div>
                                {% endif %}
                            </div>
                            {% if order.preferred_days %}
                            <div style="margin-top: 10px;">
                                <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">D√≠as Preferidos</div>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    {% for day in order.preferred_days %}
                                    <span style="background: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; border: 1px solid #ddd;">
                                        {% if day == 'monday' %}Lun
                                        {% elif day == 'tuesday' %}Mar
                                        {% elif day == 'wednesday' %}Mi√©
                                        {% elif day == 'thursday' %}Jue
                                        {% elif day == 'friday' %}Vie
                                        {% elif day == 'saturday' %}S√°b
                                        {% elif day == 'sunday' %}Dom
                                        {% else %}{{ day }}{% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}

                        {% if order.notes %}
                        <div style="background: #fff9e6; border-radius: 8px; padding: 12px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600;">üìù Notas del Cliente</div>
                            <div style="color: #333; font-size: 0.9rem;">{{ order.notes }}</div>
                        </div>
                        {% endif %}

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            {% if not order.sessions_generated and order.status == 'pending' %}
                            <button onclick="generarSesiones({{ order.id }})" 
                                    class="btn-primary" 
                                    style="background: #4CAF50; padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                                ‚ú® Generar Sesiones
                            </button>
                            {% elif order.sessions_generated %}
                            <span style="background: #d4edda; color: #155724; padding: 10px 20px; border-radius: 6px; font-weight: 600;">
                                ‚úÖ Sesiones Generadas
                            </span>
                            {% endif %}
                            <button onclick="verDetallesOrden({{ order.id }})" 
                                    class="btn-secondary" 
                                    style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-weight: 600;">
                                üëÅÔ∏è Ver Detalles
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div>
                        <h3 style="color: #666;">No hay solicitudes pendientes</h3>
                        <p>Las nuevas solicitudes de clientes aparecer√°n aqu√≠</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- PRECIOS TAB -->
            <div class="tab-panel" id="precios-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Servicios y Precios</h2>
                    <button class="btn-primary" onclick="mostrarFormularioNuevoPrecio()">‚ûï Nuevo Precio</button>
                </div>

                <!-- Formulario Nuevo Precio -->
                <div id="formularioPrecio" class="form-container" style="display:none;">
                    <h3 id="formulario-titulo">Crear Nuevo Precio</h3>
                    <form id="precioForm" method="POST" action="{% url 'admin_create_price' %}">
                        {% csrf_token %}
                        <input type="hidden" id="precio_id" name="precio_id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="servicio">* Categor√≠a/Servicio</label>
                                <select id="servicio" name="servicio" required onchange="toggleNuevoServicio()">
                                    <option value="">Selecciona una categor√≠a</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}">{{ service.name }}</option>
                                    {% endfor %}
                                    <option value="nuevo" style="background: #e8f5e9; font-weight: bold;">‚ûï Crear Nuevo Servicio</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="plan">* Nombre del Plan</label>
                                <input type="text" id="plan" name="plan" required placeholder="Ej: Plan B√°sico">
                            </div>
                        </div>

                        <!-- Campos para crear nuevo servicio (ocultos por defecto) -->
                        <div id="nuevo-servicio-fields" style="display: none; background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #667eea;">
                            <h4 style="margin: 0 0 10px 0; color: #667eea;">üìù Datos del Nuevo Servicio</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="new_service_name">* Nombre del Servicio</label>
                                    <input type="text" id="new_service_name" name="new_service_name" placeholder="Ej: Tutor√≠a, Terapia, Plan Estudiante">
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        Este ser√° el nombre que ver√°n los usuarios
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label for="new_service_slug">* Identificador (slug)</label>
                                    <input type="text" id="new_service_slug" name="new_service_slug" placeholder="Ej: tutoria, terapia, plan-estudiante" pattern="[a-z0-9-]+">
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        Solo letras min√∫sculas, n√∫meros y guiones. Sin espacios ni tildes.
                                    </small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="new_service_description">Descripci√≥n del Servicio</label>
                                <textarea id="new_service_description" name="new_service_description" rows="2" placeholder="Describe brevemente el servicio..."></textarea>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="precio">* Precio</label>
                                <input type="number" id="precio" name="precio" step="0.01" required placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label for="moneda">* Moneda</label>
                                <select id="moneda" name="moneda" required>
                                    <option value="CLP">CLP - Peso Chileno</option>
                                    <option value="USD">USD - D√≥lar</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="descripcion">Descripci√≥n</label>
                            <textarea id="descripcion" name="descripcion" rows="3" placeholder="Describe las caracter√≠sticas del plan..."></textarea>
                        </div>

                        <!-- Campos de sesiones seg√∫n el tipo de servicio -->
                        <div id="sesiones-container" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4 style="margin-top: 0; color: #667eea;">‚öôÔ∏è Configuraci√≥n de Sesiones</h4>
                            
                            <!-- Para servicios individuales (tutor√≠a o terapia) -->
                            <div id="sesiones-individual" style="display: none;">
                                <div class="form-group">
                                    <label for="number_of_sessions">* N√∫mero de Sesiones</label>
                                    <input type="number" id="number_of_sessions" name="number_of_sessions" min="1" max="100" value="4" placeholder="Ej: 8">
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        Total de sesiones que incluye este plan (entre 1 y 100)
                                    </small>
                                </div>
                            </div>

                            <!-- Para Plan Estudiante -->
                            <div id="sesiones-estudiante" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="tutoring_sessions">* Sesiones de Tutor√≠a</label>
                                        <input type="number" id="tutoring_sessions" name="tutoring_sessions" min="1" max="100" value="8" placeholder="Ej: 12">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            üìö Sesiones semanales de tutor√≠a
                                        </small>
                                    </div>

                                    <div class="form-group">
                                        <label for="therapy_sessions">* Sesiones de Terapia</label>
                                        <input type="number" id="therapy_sessions" name="therapy_sessions" min="1" max="100" value="8" placeholder="Ej: 12">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            üß† Sesiones semanales de terapia
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üíæ Guardar</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioPrecio()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Precios -->
                <div class="prices-list">
                    {% for service in services %}
                    <div class="service-prices-group" style="position: relative; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 30px; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">{{ service.name }} <small style="color: #999; font-size: 0.7em;">({{ service.slug }})</small></h3>
                            <button class="btn-icon btn-danger" 
                                    onclick="eliminarServicio({{ service.id }}, '{{ service.name|escapejs }}')" 
                                    title="Eliminar servicio completo"
                                    style="padding: 8px 12px; font-size: 1.2rem;">
                                üóëÔ∏è Eliminar Servicio
                            </button>
                        </div>
                        {% if service.description %}
                        <p style="color: #666; margin: 0 0 15px 0; font-size: 0.9em;">{{ service.description }}</p>
                        {% endif %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Plan</th>
                                        <th>Precio</th>
                                        <th>Sesiones</th>
                                        <th>Descripci√≥n</th>
                                        <th>‚≠ê Destacado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for price in service.prices.all %}
                                    <tr id="price-row-{{ price.id }}">
                                        <td><strong>{{ price.plan }}</strong></td>
                                        <td>${{ price.price }} {{ price.currency }}</td>
                                        <td>
                                            {% if service.slug == 'plan-estudiante' %}
                                                <span style="background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                                                    üìö {{ price.tutoring_sessions }} tut.
                                                </span>
                                                <span style="background: #fff3e0; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                                                    üß† {{ price.therapy_sessions }} ter.
                                                </span>
                                            {% else %}
                                                <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                                                    üìä {{ price.number_of_sessions }} sesiones
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>{{ price.description|truncatewords:15 }}</td>
                                        <td style="text-align: center;">
                                            <label class="switch" title="{% if price.is_featured %}Quitar de destacados{% else %}Marcar como destacado{% endif %}">
                                                <input type="checkbox" 
                                                       id="featured-{{ price.id }}" 
                                                       {% if price.is_featured %}checked{% endif %}
                                                       onchange="toggleFeatured({{ price.id }}, this.checked)">
                                                <span class="slider"></span>
                                            </label>
                                            <span id="featured-label-{{ price.id }}" style="display: block; font-size: 0.75rem; margin-top: 4px; color: {% if price.is_featured %}#4CAF50{% else %}#999{% endif %};">
                                                {% if price.is_featured %}S√ç{% else %}NO{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn-icon" 
                                                onclick="editarPrecio({{ price.id }}, {{ price.service.id }}, '{{ price.plan|escapejs }}', {{ price.price }}, '{{ price.currency }}', '{{ price.description|escapejs }}', {{ price.number_of_sessions }}, {{ price.tutoring_sessions }}, {{ price.therapy_sessions }})" 
                                                title="Editar">‚úèÔ∏è</button>
                                            <button class="btn-icon btn-danger" onclick="eliminarPrecio({{ price.id }})" title="Eliminar">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6">No hay precios definidos</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- EMPLEADOS TAB -->
            <div class="tab-panel" id="empleados-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Empleados</h2>
                    <button class="btn-primary" onclick="mostrarFormularioNuevoEmpleado()">‚ûï Nuevo Empleado</button>
                </div>

                <!-- Formulario Nuevo Empleado -->
                <div id="formularioEmpleado" class="form-container" style="display:none;">
                    <h3>Crear Cuenta de Empleado</h3>
                    <form id="empleadoForm" method="POST" action="{% url 'admin_create_employee' %}">
                        {% csrf_token %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">* Nombre de Usuario</label>
                                <input type="text" id="username" name="username" required>
                            </div>

                            <div class="form-group">
                                <label for="email">* Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="first_name">* Nombre</label>
                                <input type="text" id="first_name" name="first_name" required>
                            </div>

                            <div class="form-group">
                                <label for="last_name">* Apellido</label>
                                <input type="text" id="last_name" name="last_name" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="password1">* Contrase√±a</label>
                                <input type="password" id="password1" name="password1" required>
                                <small>M√≠n. 8 caracteres, incluir may√∫scula, min√∫scula, n√∫mero y caracter especial</small>
                            </div>

                            <div class="form-group">
                                <label for="password2">* Confirmar Contrase√±a</label>
                                <input type="password" id="password2" name="password2" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="grupo">* Rol/Grupo</label>
                            <select id="grupo" name="grupo" required>
                                <option value="">Selecciona un rol</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="is_staff" value="1">
                                Dar permisos de staff (acceso al panel de empleado)
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üë§ Crear Empleado</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioEmpleado()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Empleados -->
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                    <table class="data-table">
                        <thead style="position: sticky; top: 0; background: white; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Grupo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td><strong>{{ employee.username }}</strong></td>
                                <td>{{ employee.get_full_name }}</td>
                                <td>{{ employee.email }}</td>
                                <td>
                                    {% for group in employee.groups.all %}
                                    <span class="badge">{{ group.name }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if employee.is_active %}
                                    <span class="status-badge status-active">Activo</span>
                                    {% else %}
                                    <span class="status-badge status-inactive">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verEmpleado({{ employee.id }})" title="Ver Detalles">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="editarEmpleado({{ employee.id }})" title="Editar">‚úèÔ∏è</button>
                                    <button class="btn-icon" onclick="toggleEstadoEmpleado({{ employee.id }})" title="Activar/Desactivar">üîÑ</button>
                                    <button class="btn-icon" onclick="eliminarEmpleado({{ employee.id }})" title="Eliminar" style="color: #dc3545;">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6">No hay empleados registrados</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES TAB -->
            <div class="tab-panel" id="clientes-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Clientes y Progreso</h2>
                    <div class="filters">
                        <input type="text" id="buscar-cliente" placeholder="üîç Buscar cliente..." class="filter-select" style="width: 250px;">
                    </div>
                </div>

                <!-- Lista de Clientes con Progreso -->
                <div class="clientes-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; max-height: 700px; overflow-y: auto; padding: 10px;">
                    {% for client in clients %}
                    <div class="cliente-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                {{ client.first_name.0|default:client.username.0|upper }}
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #333; font-size: 1.1rem;">{{ client.get_full_name|default:client.username }}</h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">@{{ client.username }}</p>
                                <p style="margin: 5px 0 0 0; color: #999; font-size: 0.85rem;">{{ client.email }}</p>
                            </div>
                        </div>

                        <!-- Estad√≠sticas del Cliente -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Asignaciones</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #667eea;">
                                        {{ client.active_assignments_count }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Sesiones</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #28a745;">
                                        {{ client.total_sessions }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Archivos</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #ffc107;">
                                        {{ client.files_count }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Actividad</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #dc3545;">
                                        {{ client.audit_count }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Asignaciones del Cliente -->
                        <div style="margin-bottom: 12px;">
                            <p style="margin: 0 0 8px 0; font-weight: 600; color: #333; font-size: 0.9rem;">Asignado a:</p>
                            {% for assignment in client.client_assignments.all %}
                            {% if assignment.is_active %}
                            <div style="background: #e8f5e9; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 600; color: #2e7d32;">{{ assignment.employee.get_full_name }}</span>
                                    <span style="color: #666; font-size: 0.85rem;"> - {{ assignment.service.name }}</span>
                                </div>
                                <span class="status-badge status-active" style="font-size: 0.7rem;">Activa</span>
                            </div>
                            {% endif %}
                            {% empty %}
                            <p style="color: #999; font-size: 0.85rem; font-style: italic;">Sin asignaciones activas</p>
                            {% endfor %}
                        </div>

                        <!-- Acciones -->
                        <div style="display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem;" onclick="verProgresoCliente({{ client.id }})">
                                üìä Progreso
                            </button>
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem;" onclick="verArchivosCliente({{ client.id }})">
                                üìÅ Archivos
                            </button>
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem; background: #ffc107;" onclick="editarCliente({{ client.id }})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem; background: #dc3545;" onclick="eliminarCliente({{ client.id }})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #ddd;">
                        <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üë•</div>
                        <h3 style="color: #666; margin-bottom: 15px;">No hay clientes registrados</h3>
                        <p style="color: #999; margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto;">
                            Los clientes aparecer√°n aqu√≠ autom√°ticamente cuando <strong>generes las sesiones</strong> de una solicitud desde la pesta√±a "Solicitudes". 
                            Al generar sesiones, se crea autom√°ticamente una cuenta de usuario para el cliente.
                        </p>
                        <a href="#solicitudes-tab" onclick="showTab('solicitudes')" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                            üìã Ver Solicitudes Pendientes
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ASIGNACIONES TAB -->
            <div class="tab-panel" id="asignaciones-tab">
                <div class="panel-header">
                    <h2>Asignaci√≥n Cliente-Empleado</h2>
                    <button class="btn-primary" onclick="mostrarFormularioAsignacion()">‚ûï Nueva Asignaci√≥n</button>
                </div>

                <!-- Formulario Nueva Asignaci√≥n -->
                <div id="formularioAsignacion" class="form-container" style="display:none;">
                    <h3>Asignar Cliente a Empleado</h3>
                    <form id="asignacionForm" method="POST" action="{% url 'admin_create_assignment' %}">
                        {% csrf_token %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cliente">* Cliente</label>
                                <select id="cliente" name="cliente" required>
                                    <option value="">Selecciona un cliente</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.username }} - {{ client.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="empleado">* Empleado</label>
                                <select id="empleado" name="empleado" required>
                                    <option value="">Selecciona un empleado</option>
                                    {% for emp in employees %}
                                    <option value="{{ emp.id }}">{{ emp.username }} - {{ emp.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="servicio_asignacion">* Servicio</label>
                            <select id="servicio_asignacion" name="servicio" required>
                                <option value="">Selecciona un servicio</option>
                                {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="notas_asignacion">Notas</label>
                            <textarea id="notas_asignacion" name="notas" rows="3" placeholder="Informaci√≥n adicional sobre la asignaci√≥n..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üîó Crear Asignaci√≥n</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioAsignacion()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Filtros de B√∫squeda Asignaciones -->
                <div class="filters-container" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-cliente-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üîç Buscar Cliente</label>
                            <input type="text" id="buscar-cliente-asignacion" class="form-control" placeholder="Nombre de usuario del cliente..." style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-empleado-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üë®‚Äç‚öïÔ∏è Buscar Empleado</label>
                            <input type="text" id="buscar-empleado-asignacion" class="form-control" placeholder="Nombre de usuario del empleado..." style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-servicio-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üõ†Ô∏è Servicio</label>
                            <select id="filtro-servicio-asignacion" class="form-control" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="Terapia">Terapia</option>
                                <option value="Tutor√≠a">Tutor√≠a</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-estado-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üìä Estado</label>
                            <select id="filtro-estado-asignacion" class="form-control" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="activa">Activa</option>
                                <option value="inactiva">Inactiva</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-desde-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Desde</label>
                            <input type="date" id="fecha-desde-asignacion" class="form-control" style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-hasta-asignacion" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Hasta</label>
                            <input type="date" id="fecha-hasta-asignacion" class="form-control" style="width: 100%;">
                        </div>
                        
                        <button class="btn-secondary" onclick="limpiarFiltrosAsignaciones()" style="padding: 8px 20px; height: 38px;">üóëÔ∏è Limpiar</button>
                        
                        <div style="padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500; height: 38px; display: flex; align-items: center;">
                            <span id="contador-asignaciones">{{ assignments|length }} asignaciones</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Asignaciones -->
                <div class="table-responsive">
                    <table class="data-table" id="tabla-asignaciones">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Empleado</th>
                                <th>Servicio</th>
                                <th>Fecha Asignaci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr data-cliente="{{ assignment.client.username }}"
                                data-empleado="{{ assignment.employee.username }}"
                                data-servicio="{{ assignment.service.name }}"
                                data-estado="{% if assignment.is_active %}activa{% else %}inactiva{% endif %}"
                                data-fecha="{{ assignment.assigned_at|date:'Y-m-d' }}">
                                <td><strong>{{ assignment.client.username }}</strong><br><small>{{ assignment.client.get_full_name }}</small></td>
                                <td><strong>{{ assignment.employee.username }}</strong><br><small>{{ assignment.employee.get_full_name }}</small></td>
                                <td>{{ assignment.service.name }}</td>
                                <td>{{ assignment.assigned_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if assignment.is_active %}
                                    <span class="status-badge status-active">Activa</span>
                                    {% else %}
                                    <span class="status-badge status-inactive">Inactiva</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verAsignacion({{ assignment.id }})" title="Ver">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="toggleAsignacion({{ assignment.id }})" title="Activar/Desactivar">üîÑ</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="sin-asignaciones"><td colspan="6">No hay asignaciones registradas</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SESIONES TAB -->
            <div class="tab-panel" id="sesiones-tab">
                <div class="panel-header">
                    <h2>Fechas de Sesiones</h2>
                    <button class="btn-primary" onclick="mostrarFormularioSesion()">‚ûï Nueva Sesi√≥n</button>
                </div>

                <!-- Formulario Nueva Sesi√≥n -->
                <div id="formularioSesion" class="form-container" style="display:none;">
                    <h3>Programar Nueva Sesi√≥n</h3>
                    <form id="sesionForm" method="POST" action="{% url 'admin_create_session' %}">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="asignacion">* Asignaci√≥n Cliente-Empleado</label>
                            <select id="asignacion" name="asignacion" required>
                                <option value="">Selecciona una asignaci√≥n</option>
                                {% for assignment in assignments %}
                                {% if assignment.is_active %}
                                <option value="{{ assignment.id }}">{{ assignment.client.username }} ‚Üí {{ assignment.employee.username }} ({{ assignment.service.name }})</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha">* Fecha</label>
                                <input type="date" id="fecha" name="fecha" required>
                            </div>

                            <div class="form-group">
                                <label for="hora">* Hora</label>
                                <input type="time" id="hora" name="hora" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="duracion">* Duraci√≥n (minutos)</label>
                                <input type="number" id="duracion" name="duracion" value="60" min="15" max="240" required>
                            </div>

                            <div class="form-group">
                                <label for="estado">* Estado</label>
                                <select id="estado" name="estado" required>
                                    <option value="scheduled">Programada</option>
                                    <option value="confirmed">Confirmada</option>
                                    <option value="completed">Completada</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notas_sesion">Notas</label>
                            <textarea id="notas_sesion" name="notas" rows="3" placeholder="Informaci√≥n sobre la sesi√≥n..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üìÖ Crear Sesi√≥n</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioSesion()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Filtros de B√∫squeda -->
                <div class="filters-container" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="filter-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-sesion" style="display: block; margin-bottom: 5px; font-weight: 500;">üîç Buscar Cliente</label>
                            <input type="text" id="buscar-sesion" class="form-control" placeholder="Nombre de usuario o email del cliente..." style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-empleado" style="display: block; margin-bottom: 5px; font-weight: 500;">üë®‚Äç‚öïÔ∏è Empleado</label>
                            <select id="filtro-empleado" class="form-control" style="width: 100%;">
                                <option value="">Todos</option>
                                {% for emp in employees %}
                                <option value="{{ emp.username }}">{{ emp.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-servicio" style="display: block; margin-bottom: 5px; font-weight: 500;">üõ†Ô∏è Servicio</label>
                            <select id="filtro-servicio" class="form-control" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="Terapia">Terapia</option>
                                <option value="Tutor√≠a">Tutor√≠a</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-estado-sesion" style="display: block; margin-bottom: 5px; font-weight: 500;">üìä Estado</label>
                            <select id="filtro-estado-sesion" class="form-control" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="scheduled">Programada</option>
                                <option value="confirmed">Confirmada</option>
                                <option value="completed">Completada</option>
                                <option value="cancelled">Cancelada</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-desde" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Desde</label>
                            <input type="date" id="fecha-desde" class="form-control" style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-hasta" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Hasta</label>
                            <input type="date" id="fecha-hasta" class="form-control" style="width: 100%;">
                        </div>
                        
                        <button class="btn-secondary" onclick="limpiarFiltrosSesiones()" style="padding: 8px 20px; height: 38px;">üóëÔ∏è Limpiar</button>
                        
                        <div style="padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500; height: 38px; display: flex; align-items: center;">
                            <span id="contador-sesiones">{{ sessions|length }} sesiones</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Sesiones -->
                <div class="table-responsive">
                    <table class="data-table" id="tabla-sesiones">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Cliente</th>
                                <th>Empleado</th>
                                <th>Servicio</th>
                                <th>Duraci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr data-cliente="{{ session.assignment.client.username }}" 
                                data-empleado="{{ session.assignment.employee.username }}" 
                                data-servicio="{{ session.assignment.service.name }}" 
                                data-estado="{{ session.status }}" 
                                data-fecha="{{ session.scheduled_date|date:'Y-m-d' }}">
                                <td><strong>{{ session.scheduled_date|date:"d/m/Y" }}</strong><br>{{ session.scheduled_date|time:"H:i" }}</td>
                                <td>{{ session.assignment.client.username }}</td>
                                <td>{{ session.assignment.employee.username }}</td>
                                <td>{{ session.assignment.service.name }}</td>
                                <td>{{ session.duration_minutes }} min</td>
                                <td>
                                    <span class="status-badge status-{{ session.status }}">{{ session.get_status_display }}</span>
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verSesion({{ session.id }})" title="Ver">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="editarSesion({{ session.id }})" title="Editar">‚úèÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="sin-sesiones"><td colspan="7">No hay sesiones programadas</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ARCHIVOS TAB -->
            <div class="tab-panel" id="archivos-tab">
                <div class="panel-header">
                    <h2>Archivos Compartidos</h2>
                    <div class="filters">
                        <select id="filtro-asignacion" class="filter-select">
                            <option value="">Todas las asignaciones</option>
                            {% for assignment in assignments %}
                            <option value="{{ assignment.id }}">{{ assignment.client.username }} - {{ assignment.employee.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Lista de Archivos -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Archivo</th>
                                <th>Tipo</th>
                                <th>Tama√±o</th>
                                <th>Subido Por</th>
                                <th>Cliente ‚Üí Empleado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <strong>{{ file.file_name }}</strong>
                                    {% if file.description %}
                                    <br><small>{{ file.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ file.get_file_type_display }}</td>
                                <td>{{ file.get_file_size_display }}</td>
                                <td>{{ file.uploaded_by.username }}</td>
                                <td>{{ file.assignment.client.username }} ‚Üí {{ file.assignment.employee.username }}</td>
                                <td>{{ file.uploaded_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <button class="btn-icon" onclick="descargarArchivo({{ file.id }})" title="Descargar">‚¨áÔ∏è</button>
                                    <button class="btn-icon btn-danger" onclick="eliminarArchivo({{ file.id }})" title="Eliminar">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7">No hay archivos compartidos</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AUDITOR√çA TAB -->
            <div class="tab-panel" id="auditoria-tab">
                <div class="panel-header">
                    <h2>Auditor√≠a de Clientes</h2>
                </div>

                <!-- Filtros de B√∫squeda Auditor√≠a -->
                <div class="filters-container" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-usuario-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">üë§ Buscar Usuario</label>
                            <input type="text" id="buscar-usuario-auditoria" class="form-control" placeholder="Nombre de usuario..." style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="filtro-accion-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">‚ö° Acci√≥n</label>
                            <select id="filtro-accion-auditoria" class="form-control" style="width: 100%;">
                                <option value="">Todas las acciones</option>
                                <option value="login">Inicio de Sesi√≥n</option>
                                <option value="logout">Cierre de Sesi√≥n</option>
                                <option value="order_created">Orden Creada</option>
                                <option value="session_completed">Sesi√≥n Completada</option>
                                <option value="file_uploaded">Archivo Subido</option>
                                <option value="profile_updated">Perfil Actualizado</option>
                                <option value="password_changed">Contrase√±a Cambiada</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-descripcion-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">üîç Descripci√≥n</label>
                            <input type="text" id="buscar-descripcion-auditoria" class="form-control" placeholder="Buscar en descripci√≥n..." style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="buscar-ip-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">üåê IP</label>
                            <input type="text" id="buscar-ip-auditoria" class="form-control" placeholder="Direcci√≥n IP..." style="width: 100%;">
                        </div>
                    </div>
                    
                    <div class="filter-row" style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-desde-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Desde</label>
                            <input type="date" id="fecha-desde-auditoria" class="form-control" style="width: 100%;">
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label for="fecha-hasta-auditoria" style="display: block; margin-bottom: 5px; font-weight: 500;">üìÖ Hasta</label>
                            <input type="date" id="fecha-hasta-auditoria" class="form-control" style="width: 100%;">
                        </div>
                        
                        <button class="btn-secondary" onclick="limpiarFiltrosAuditoria()" style="padding: 8px 20px; height: 38px;">üóëÔ∏è Limpiar</button>
                        
                        <div style="padding: 8px 15px; background: white; border-radius: 4px; font-weight: 500; height: 38px; display: flex; align-items: center;">
                            <span id="contador-auditoria">{{ audit_logs|length }} registros</span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Auditor√≠a -->
                <div class="table-responsive">
                    <table class="data-table" id="tabla-auditoria">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acci√≥n</th>
                                <th>Descripci√≥n</th>
                                <th>IP</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in audit_logs %}
                            <tr data-usuario="{{ log.user.username }}"
                                data-accion="{{ log.action }}"
                                data-descripcion="{{ log.description }}"
                                data-ip="{{ log.ip_address|default:'' }}"
                                data-fecha="{{ log.timestamp|date:'Y-m-d' }}">
                                <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
                                <td><strong>{{ log.user.username }}</strong></td>
                                <td><span class="badge badge-{{ log.action }}">{{ log.get_action_display }}</span></td>
                                <td>{{ log.description|truncatewords:20 }}</td>
                                <td>{{ log.ip_address|default:"N/A" }}</td>
                                <td>
                                    <button class="btn-icon" onclick="verAuditoria({{ log.id }})" title="Ver">üëÅÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="sin-auditoria"><td colspan="6">No hay registros de auditor√≠a</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PANEL EMPLEADO TAB -->
            <div class="tab-panel" id="panel-empleado-tab">
                <div class="panel-header">
                    <h2>Vista de Panel Empleado (Auditor√≠a de Clientes)</h2>
                    <p style="color: #666; margin: 10px 0 0 0;">Vista completa del dashboard de empleado para supervisar estudiantes y solicitudes</p>
                </div>

                <!-- Panel de opciones -->
                <div style="background: white; border-radius: 12px; padding: 20px; min-height: 600px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <a href="{% url 'empleado_dashboard' %}" target="_blank" class="btn-primary" style="display: inline-block; padding: 12px 24px; text-decoration: none;">
                            üîó Abrir Panel de Empleado en Nueva Pesta√±a
                        </a>
                        <button class="btn-secondary" onclick="cargarPanelEmpleadoIframe()" style="padding: 12px 24px; margin-left: 10px;">
                            üîÑ Cargar Panel en Vista Integrada
                        </button>
                    </div>
                    
                    <div id="panel-empleado-container" style="border: 2px solid #e9ecef; border-radius: 8px; min-height: 500px; background: #f8f9fa;">
                        <div style="padding: 60px 20px; text-align: center; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                            <h3 style="color: #333; margin-bottom: 10px;">Panel de Empleado</h3>
                            <p>Opciones para acceder al panel de empleado:</p>
                            <ul style="list-style: none; padding: 0; margin: 20px 0; text-align: left; max-width: 500px; margin: 20px auto;">
                                <li style="padding: 10px 0;"><strong>üîó Nueva pesta√±a:</strong> Abre el panel completo en una ventana separada (Recomendado)</li>
                                <li style="padding: 10px 0;"><strong>üîÑ Vista integrada:</strong> Carga el panel dentro de esta p√°gina (puede tener limitaciones de navegador)</li>
                            </ul>
                            <p style="font-size: 0.9rem; margin-top: 15px; color: #999;">Aqu√≠ podr√°s auditar estudiantes, ver solicitudes y gestionar el progreso de los clientes</p>
                            
                            <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                                <strong>üí° Nota:</strong> Si la vista integrada no carga correctamente, usa la opci√≥n de "Nueva Pesta√±a"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal Editar Empleado -->
<div id="modalEditarEmpleado" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
            <h2 style="margin: 0; font-size: 24px;">‚úèÔ∏è Editar Empleado</h2>
            <button onclick="cerrarModalEmpleado()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 30px;">
            <form id="formEditarEmpleado">
                <input type="hidden" id="edit_employee_id">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Usuario *</label>
                        <input type="text" id="edit_username" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email *</label>
                        <input type="email" id="edit_email" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre *</label>
                        <input type="text" id="edit_first_name" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Apellido *</label>
                        <input type="text" id="edit_last_name" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rol/Grupo *</label>
                    <select id="edit_grupo" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                        {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nueva Contrase√±a (dejar vac√≠o para no cambiar)</label>
                    <input type="password" id="edit_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="edit_is_staff" style="margin-right: 10px; width: 20px; height: 20px;">
                        <span style="font-weight: 600;">Acceso al panel de administraci√≥n</span>
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: right;">
            <button onclick="cerrarModalEmpleado()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-right: 10px; cursor: pointer;">Cancelar</button>
            <button onclick="guardarEmpleado()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">üíæ Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal Editar Cliente -->
<div id="modalEditarCliente" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
            <h2 style="margin: 0; font-size: 24px;">‚úèÔ∏è Editar Cliente</h2>
            <button onclick="cerrarModalCliente()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 30px;">
            <form id="formEditarCliente">
                <input type="hidden" id="edit_client_id">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Usuario *</label>
                        <input type="text" id="edit_client_username" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email *</label>
                        <input type="email" id="edit_client_email" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre *</label>
                        <input type="text" id="edit_client_first_name" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Apellido *</label>
                        <input type="text" id="edit_client_last_name" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nueva Contrase√±a (dejar vac√≠o para no cambiar)</label>
                    <input type="password" id="edit_client_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                </div>
            </form>
        </div>
        <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: right;">
            <button onclick="cerrarModalCliente()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-right: 10px; cursor: pointer;">Cancelar</button>
            <button onclick="guardarCliente()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">üíæ Guardar Cambios</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin-dashboard.js' %}"></script>
<script>
// Funciones para mostrar/ocultar formularios
function mostrarFormularioNuevoServicio() {
    document.getElementById('formularioServicio').style.display = 'block';
    document.getElementById('servicio-formulario-titulo').textContent = 'Crear Nuevo Servicio';
    document.getElementById('servicioForm').reset();
    document.getElementById('servicio_id').value = '';
    
    // Restaurar la acci√≥n del formulario a crear
    const form = document.getElementById('servicioForm');
    form.action = '{% url "admin_create_service" %}';
    
    // Hacer scroll al formulario
    document.getElementById('formularioServicio').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function ocultarFormularioServicio() {
    document.getElementById('formularioServicio').style.display = 'none';
    document.getElementById('servicioForm').reset();
}

function toggleNuevoServicio() {
    const servicioSelect = document.getElementById('servicio');
    const nuevoServicioFields = document.getElementById('nuevo-servicio-fields');
    const newServiceName = document.getElementById('new_service_name');
    const newServiceSlug = document.getElementById('new_service_slug');
    
    if (servicioSelect.value === 'nuevo') {
        nuevoServicioFields.style.display = 'block';
        newServiceName.required = true;
        newServiceSlug.required = true;
    } else {
        nuevoServicioFields.style.display = 'none';
        newServiceName.required = false;
        newServiceSlug.required = false;
    }
}

function mostrarFormularioNuevoPrecio() {
    document.getElementById('formularioPrecio').style.display = 'block';
    document.getElementById('formulario-titulo').textContent = 'Crear Nuevo Precio';
    document.getElementById('precioForm').reset();
    document.getElementById('precio_id').value = '';
    
    // Ocultar campos de nuevo servicio
    document.getElementById('nuevo-servicio-fields').style.display = 'none';
    document.getElementById('new_service_name').required = false;
    document.getElementById('new_service_slug').required = false;
    
    // Restaurar la acci√≥n del formulario a crear
    const form = document.getElementById('precioForm');
    form.action = '{% url "admin_create_price" %}';
    
    // Hacer scroll al formulario
    document.getElementById('formularioPrecio').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function ocultarFormularioPrecio() {
    document.getElementById('formularioPrecio').style.display = 'none';
    document.getElementById('precioForm').reset();
    document.getElementById('nuevo-servicio-fields').style.display = 'none';
}

function mostrarFormularioNuevoEmpleado() {
    document.getElementById('formularioEmpleado').style.display = 'block';
    document.getElementById('empleadoForm').reset();
}

function ocultarFormularioEmpleado() {
    document.getElementById('formularioEmpleado').style.display = 'none';
}

function mostrarFormularioAsignacion() {
    document.getElementById('formularioAsignacion').style.display = 'block';
    document.getElementById('asignacionForm').reset();
}

function ocultarFormularioAsignacion() {
    document.getElementById('formularioAsignacion').style.display = 'none';
}

function mostrarFormularioSesion() {
    document.getElementById('formularioSesion').style.display = 'block';
    document.getElementById('sesionForm').reset();
}

function ocultarFormularioSesion() {
    document.getElementById('formularioSesion').style.display = 'none';
}

// Funciones de acciones
function editarPrecio(id, servicioId, plan, precio, moneda, descripcion, numberSessions, tutoringSessions, therapySessions) {
    // Mostrar el formulario
    mostrarFormularioNuevoPrecio();
    
    // Cambiar el t√≠tulo
    document.getElementById('formulario-titulo').textContent = 'Editar Precio';
    
    // Llenar el formulario con los datos existentes
    document.getElementById('precio_id').value = id;
    document.getElementById('servicio').value = servicioId;
    document.getElementById('plan').value = plan;
    document.getElementById('precio').value = precio;
    document.getElementById('moneda').value = moneda;
    document.getElementById('descripcion').value = descripcion;
    document.getElementById('number_of_sessions').value = numberSessions || 4;
    document.getElementById('tutoring_sessions').value = tutoringSessions || 8;
    document.getElementById('therapy_sessions').value = therapySessions || 8;
    
    // Mostrar campos apropiados seg√∫n el servicio
    actualizarCamposSesiones();
    
    // Cambiar la acci√≥n del formulario
    const form = document.getElementById('precioForm');
    form.action = `/admin/precio/editar/${id}/`;
    
    // Hacer scroll al formulario
    document.getElementById('formularioPrecio').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function eliminarPrecio(id) {
    if(confirm('¬øEst√°s seguro de eliminar este precio? Esta acci√≥n no se puede deshacer.')) {
        window.location.href = `/admin/precio/eliminar/${id}/`;
    }
}

function eliminarServicio(id, nombre) {
    if(confirm(`¬øEst√°s seguro de eliminar el servicio "${nombre}"?\n\n‚ö†Ô∏è ADVERTENCIA: Esto eliminar√° tambi√©n TODOS los precios asociados a este servicio.\n\nEsta acci√≥n no se puede deshacer.`)) {
        window.location.href = `/admin/servicio/eliminar/${id}/`;
    }
}

// Funci√≥n para marcar/desmarcar plan como destacado
function toggleFeatured(priceId, isFeatured) {
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/admin/precio/toggle-featured/${priceId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ is_featured: isFeatured })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar el label
            const label = document.getElementById(`featured-label-${priceId}`);
            if (label) {
                label.textContent = isFeatured ? 'S√ç' : 'NO';
                label.style.color = isFeatured ? '#4CAF50' : '#999';
            }
            
            // Mostrar mensaje de √©xito
            showNotification(data.message, 'success');
        } else {
            // Revertir el checkbox si hubo error
            const checkbox = document.getElementById(`featured-${priceId}`);
            if (checkbox) {
                checkbox.checked = !isFeatured;
            }
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revertir el checkbox
        const checkbox = document.getElementById(`featured-${priceId}`);
        if (checkbox) {
            checkbox.checked = !isFeatured;
        }
        showNotification('Error al actualizar el plan destacado', 'error');
    });
}

// Funci√≥n auxiliar para mostrar notificaciones
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Funci√≥n para mostrar/ocultar campos de sesiones seg√∫n el servicio
function actualizarCamposSesiones() {
    const servicioSelect = document.getElementById('servicio');
    const servicioId = servicioSelect.value;
    const servicioText = servicioSelect.options[servicioSelect.selectedIndex]?.text || '';
    
    const sesionesIndividual = document.getElementById('sesiones-individual');
    const sesionesEstudiante = document.getElementById('sesiones-estudiante');
    
    // Ocultar ambos por defecto
    sesionesIndividual.style.display = 'none';
    sesionesEstudiante.style.display = 'none';
    
    // Mostrar el apropiado seg√∫n el servicio
    if (servicioText.toLowerCase().includes('estudiante')) {
        sesionesEstudiante.style.display = 'block';
    } else if (servicioId) {
        sesionesIndividual.style.display = 'block';
    }
}

function verEmpleado(id) {
    fetch(`/admin/empleado/datos/${id}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const emp = data.employee;
                alert(`üìã Informaci√≥n del Empleado\n\nUsuario: ${emp.username}\nNombre: ${emp.first_name} ${emp.last_name}\nEmail: ${emp.email}\nGrupo: ${emp.grupo_name}\nEstado: ${emp.is_active ? 'Activo' : 'Inactivo'}`);
            }
        })
        .catch(err => console.error('Error:', err));
}

function editarEmpleado(id) {
    fetch(`/admin/empleado/datos/${id}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const emp = data.employee;
                document.getElementById('edit_employee_id').value = emp.id;
                document.getElementById('edit_username').value = emp.username;
                document.getElementById('edit_email').value = emp.email;
                document.getElementById('edit_first_name').value = emp.first_name;
                document.getElementById('edit_last_name').value = emp.last_name;
                document.getElementById('edit_grupo').value = emp.grupo_id;
                document.getElementById('edit_is_staff').checked = emp.is_staff;
                document.getElementById('edit_password').value = '';
                document.getElementById('modalEditarEmpleado').style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error al cargar datos del empleado');
        });
}

function cerrarModalEmpleado() {
    document.getElementById('modalEditarEmpleado').style.display = 'none';
}

function guardarEmpleado() {
    const employeeId = document.getElementById('edit_employee_id').value;
    const formData = new FormData();
    formData.append('username', document.getElementById('edit_username').value);
    formData.append('email', document.getElementById('edit_email').value);
    formData.append('first_name', document.getElementById('edit_first_name').value);
    formData.append('last_name', document.getElementById('edit_last_name').value);
    formData.append('grupo', document.getElementById('edit_grupo').value);
    formData.append('is_staff', document.getElementById('edit_is_staff').checked ? '1' : '0');
    
    const newPassword = document.getElementById('edit_password').value;
    if (newPassword) {
        formData.append('new_password', newPassword);
    }

    fetch(`/admin/empleado/editar/${employeeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            cerrarModalEmpleado();
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Error al guardar cambios');
    });
}

function eliminarEmpleado(id) {
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este empleado?\n\nEsta acci√≥n NO se puede deshacer.\nSe eliminar√°n todos sus datos y asignaciones.')) {
        return;
    }

    fetch(`/admin/empleado/eliminar/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Error al eliminar empleado');
    });
}

function editarCliente(id) {
    fetch(`/admin/cliente/datos/${id}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const client = data.client;
                document.getElementById('edit_client_id').value = client.id;
                document.getElementById('edit_client_username').value = client.username;
                document.getElementById('edit_client_email').value = client.email;
                document.getElementById('edit_client_first_name').value = client.first_name;
                document.getElementById('edit_client_last_name').value = client.last_name;
                document.getElementById('edit_client_password').value = '';
                document.getElementById('modalEditarCliente').style.display = 'block';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error al cargar datos del cliente');
        });
}

function cerrarModalCliente() {
    document.getElementById('modalEditarCliente').style.display = 'none';
}

function guardarCliente() {
    const clientId = document.getElementById('edit_client_id').value;
    const formData = new FormData();
    formData.append('username', document.getElementById('edit_client_username').value);
    formData.append('email', document.getElementById('edit_client_email').value);
    formData.append('first_name', document.getElementById('edit_client_first_name').value);
    formData.append('last_name', document.getElementById('edit_client_last_name').value);
    
    const newPassword = document.getElementById('edit_client_password').value;
    if (newPassword) {
        formData.append('new_password', newPassword);
    }

    fetch(`/admin/cliente/editar/${clientId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            cerrarModalCliente();
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Error al guardar cambios');
    });
}

function eliminarCliente(id) {
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este cliente?\n\nEsta acci√≥n NO se puede deshacer.\nSe eliminar√°n todos sus datos, asignaciones, sesiones y archivos.')) {
        return;
    }

    fetch(`/admin/cliente/eliminar/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('‚ùå Error al eliminar cliente');
    });
}

function toggleEstadoEmpleado(id) {
    if(confirm('¬øCambiar el estado de este empleado (activar/desactivar)?')) {
        window.location.href = `/admin/empleado/toggle/${id}/`;
    }
}

function verAsignacion(id) {
    alert('Ver asignaci√≥n ID: ' + id + '\n\nEsta funcionalidad mostrar√° un modal con los detalles completos de la asignaci√≥n.');
}

function toggleAsignacion(id) {
    if(confirm('¬øCambiar el estado de esta asignaci√≥n (activar/desactivar)?')) {
        window.location.href = `/admin/asignacion/toggle/${id}/`;
    }
}

// Filtrado de asignaciones
function filtrarAsignaciones() {
    const buscarCliente = document.getElementById('buscar-cliente-asignacion').value.toLowerCase();
    const buscarEmpleado = document.getElementById('buscar-empleado-asignacion').value.toLowerCase();
    const servicioFiltro = document.getElementById('filtro-servicio-asignacion').value.toLowerCase();
    const estadoFiltro = document.getElementById('filtro-estado-asignacion').value.toLowerCase();
    const fechaDesde = document.getElementById('fecha-desde-asignacion').value;
    const fechaHasta = document.getElementById('fecha-hasta-asignacion').value;
    
    const tabla = document.getElementById('tabla-asignaciones');
    const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let contadorVisibles = 0;
    
    for (let i = 0; i < filas.length; i++) {
        const fila = filas[i];
        
        // Skip the "no assignments" row
        if (fila.id === 'sin-asignaciones') continue;
        
        const cliente = fila.getAttribute('data-cliente').toLowerCase();
        const empleado = fila.getAttribute('data-empleado').toLowerCase();
        const servicio = fila.getAttribute('data-servicio').toLowerCase();
        const estado = fila.getAttribute('data-estado').toLowerCase();
        const fecha = fila.getAttribute('data-fecha');
        
        let mostrar = true;
        
        // Filtro de b√∫squeda de cliente
        if (buscarCliente && !cliente.includes(buscarCliente)) {
            mostrar = false;
        }
        
        // Filtro de b√∫squeda de empleado
        if (buscarEmpleado && !empleado.includes(buscarEmpleado)) {
            mostrar = false;
        }
        
        // Filtro de servicio
        if (servicioFiltro && servicio !== servicioFiltro) {
            mostrar = false;
        }
        
        // Filtro de estado
        if (estadoFiltro && estado !== estadoFiltro) {
            mostrar = false;
        }
        
        // Filtro de fecha desde
        if (fechaDesde && fecha < fechaDesde) {
            mostrar = false;
        }
        
        // Filtro de fecha hasta
        if (fechaHasta && fecha > fechaHasta) {
            mostrar = false;
        }
        
        fila.style.display = mostrar ? '' : 'none';
        if (mostrar) contadorVisibles++;
    }
    
    // Actualizar contador
    const total = filas.length - (document.getElementById('sin-asignaciones') ? 1 : 0);
    document.getElementById('contador-asignaciones').textContent = 
        contadorVisibles + ' de ' + total + ' asignaciones';
}

function limpiarFiltrosAsignaciones() {
    document.getElementById('buscar-cliente-asignacion').value = '';
    document.getElementById('buscar-empleado-asignacion').value = '';
    document.getElementById('filtro-servicio-asignacion').value = '';
    document.getElementById('filtro-estado-asignacion').value = '';
    document.getElementById('fecha-desde-asignacion').value = '';
    document.getElementById('fecha-hasta-asignacion').value = '';
    filtrarAsignaciones();
}

// Filtrado de auditor√≠a
function filtrarAuditoria() {
    const buscarUsuario = document.getElementById('buscar-usuario-auditoria').value.toLowerCase();
    const accionFiltro = document.getElementById('filtro-accion-auditoria').value.toLowerCase();
    const buscarDescripcion = document.getElementById('buscar-descripcion-auditoria').value.toLowerCase();
    const buscarIP = document.getElementById('buscar-ip-auditoria').value.toLowerCase();
    const fechaDesde = document.getElementById('fecha-desde-auditoria').value;
    const fechaHasta = document.getElementById('fecha-hasta-auditoria').value;
    
    const tabla = document.getElementById('tabla-auditoria');
    const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let contadorVisibles = 0;
    
    for (let i = 0; i < filas.length; i++) {
        const fila = filas[i];
        
        // Skip the "no audit logs" row
        if (fila.id === 'sin-auditoria') continue;
        
        const usuario = fila.getAttribute('data-usuario').toLowerCase();
        const accion = fila.getAttribute('data-accion').toLowerCase();
        const descripcion = fila.getAttribute('data-descripcion').toLowerCase();
        const ip = fila.getAttribute('data-ip').toLowerCase();
        const fecha = fila.getAttribute('data-fecha');
        
        let mostrar = true;
        
        // Filtro de b√∫squeda de usuario
        if (buscarUsuario && !usuario.includes(buscarUsuario)) {
            mostrar = false;
        }
        
        // Filtro de acci√≥n
        if (accionFiltro && accion !== accionFiltro) {
            mostrar = false;
        }
        
        // Filtro de descripci√≥n
        if (buscarDescripcion && !descripcion.includes(buscarDescripcion)) {
            mostrar = false;
        }
        
        // Filtro de IP
        if (buscarIP && !ip.includes(buscarIP)) {
            mostrar = false;
        }
        
        // Filtro de fecha desde
        if (fechaDesde && fecha < fechaDesde) {
            mostrar = false;
        }
        
        // Filtro de fecha hasta
        if (fechaHasta && fecha > fechaHasta) {
            mostrar = false;
        }
        
        fila.style.display = mostrar ? '' : 'none';
        if (mostrar) contadorVisibles++;
    }
    
    // Actualizar contador
    const total = filas.length - (document.getElementById('sin-auditoria') ? 1 : 0);
    document.getElementById('contador-auditoria').textContent = 
        contadorVisibles + ' de ' + total + ' registros';
}

function limpiarFiltrosAuditoria() {
    document.getElementById('buscar-usuario-auditoria').value = '';
    document.getElementById('filtro-accion-auditoria').value = '';
    document.getElementById('buscar-descripcion-auditoria').value = '';
    document.getElementById('buscar-ip-auditoria').value = '';
    document.getElementById('fecha-desde-auditoria').value = '';
    document.getElementById('fecha-hasta-auditoria').value = '';
    filtrarAuditoria();
}

function verSesion(id) {
    alert('Ver sesi√≥n ID: ' + id + '\n\nEsta funcionalidad mostrar√° un modal con los detalles completos de la sesi√≥n.');
}

// Filtrado de sesiones
function filtrarSesiones() {
    const buscarTexto = document.getElementById('buscar-sesion').value.toLowerCase();
    const empleadoFiltro = document.getElementById('filtro-empleado').value.toLowerCase();
    const servicioFiltro = document.getElementById('filtro-servicio').value.toLowerCase();
    const estadoFiltro = document.getElementById('filtro-estado-sesion').value.toLowerCase();
    const fechaDesde = document.getElementById('fecha-desde').value;
    const fechaHasta = document.getElementById('fecha-hasta').value;
    
    const tabla = document.getElementById('tabla-sesiones');
    const filas = tabla.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let contadorVisibles = 0;
    
    for (let i = 0; i < filas.length; i++) {
        const fila = filas[i];
        
        // Skip the "no sessions" row
        if (fila.id === 'sin-sesiones') continue;
        
        const cliente = fila.getAttribute('data-cliente').toLowerCase();
        const empleado = fila.getAttribute('data-empleado').toLowerCase();
        const servicio = fila.getAttribute('data-servicio').toLowerCase();
        const estado = fila.getAttribute('data-estado').toLowerCase();
        const fecha = fila.getAttribute('data-fecha');
        
        let mostrar = true;
        
        // Filtro de b√∫squeda de cliente
        if (buscarTexto && !cliente.includes(buscarTexto)) {
            mostrar = false;
        }
        
        // Filtro de empleado
        if (empleadoFiltro && empleado !== empleadoFiltro) {
            mostrar = false;
        }
        
        // Filtro de servicio
        if (servicioFiltro && servicio !== servicioFiltro) {
            mostrar = false;
        }
        
        // Filtro de estado
        if (estadoFiltro && estado !== estadoFiltro) {
            mostrar = false;
        }
        
        // Filtro de fecha desde
        if (fechaDesde && fecha < fechaDesde) {
            mostrar = false;
        }
        
        // Filtro de fecha hasta
        if (fechaHasta && fecha > fechaHasta) {
            mostrar = false;
        }
        
        fila.style.display = mostrar ? '' : 'none';
        if (mostrar) contadorVisibles++;
    }
    
    // Actualizar contador
    const total = filas.length - (document.getElementById('sin-sesiones') ? 1 : 0);
    document.getElementById('contador-sesiones').textContent = 
        contadorVisibles + ' de ' + total + ' sesiones';
}

function limpiarFiltrosSesiones() {
    document.getElementById('buscar-sesion').value = '';
    document.getElementById('filtro-empleado').value = '';
    document.getElementById('filtro-servicio').value = '';
    document.getElementById('filtro-estado-sesion').value = '';
    document.getElementById('fecha-desde').value = '';
    document.getElementById('fecha-hasta').value = '';
    filtrarSesiones();
}

// Event listeners para filtrado en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    // Filtros de sesiones
    const filtrosSesiones = ['buscar-sesion', 'filtro-empleado', 'filtro-servicio', 'filtro-estado-sesion', 'fecha-desde', 'fecha-hasta'];
    filtrosSesiones.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('input', filtrarSesiones);
            elemento.addEventListener('change', filtrarSesiones);
        }
    });
    
    // Filtros de asignaciones
    const filtrosAsignaciones = ['buscar-cliente-asignacion', 'buscar-empleado-asignacion', 'filtro-servicio-asignacion', 'filtro-estado-asignacion', 'fecha-desde-asignacion', 'fecha-hasta-asignacion'];
    filtrosAsignaciones.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('input', filtrarAsignaciones);
            elemento.addEventListener('change', filtrarAsignaciones);
        }
    });
    
    // Filtros de auditor√≠a
    const filtrosAuditoria = ['buscar-usuario-auditoria', 'filtro-accion-auditoria', 'buscar-descripcion-auditoria', 'buscar-ip-auditoria', 'fecha-desde-auditoria', 'fecha-hasta-auditoria'];
    filtrosAuditoria.forEach(filtroId => {
        const elemento = document.getElementById(filtroId);
        if (elemento) {
            elemento.addEventListener('input', filtrarAuditoria);
            elemento.addEventListener('change', filtrarAuditoria);
        }
    });
});

function editarSesion(id) {
    alert('Editar sesi√≥n ID: ' + id + '\n\nEsta funcionalidad permitir√° modificar la fecha, hora y estado de la sesi√≥n.');
}

function descargarArchivo(id) {
    alert('Descargar archivo ID: ' + id + '\n\nEsta funcionalidad descargar√° el archivo.');
    // window.location.href = `/admin/archivo/descargar/${id}/`;
}

function eliminarArchivo(id) {
    if(confirm('¬øEst√°s seguro de eliminar este archivo? Esta acci√≥n no se puede deshacer.')) {
        window.location.href = `/admin/archivo/eliminar/${id}/`;
    }
}

function verAuditoria(id) {
    alert('Ver detalles de auditor√≠a ID: ' + id + '\n\nEsta funcionalidad mostrar√° informaci√≥n detallada del registro de auditor√≠a.');
}

// Funciones para el tab de Clientes
function showTab(tabName) {
    // Remover clase active de todos los botones y paneles
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    
    // Activar el bot√≥n y panel correspondiente
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Scroll al tab
    setTimeout(() => {
        document.getElementById(`${tabName}-tab`).scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

function verProgresoCliente(clienteId) {
    // Cambiar al tab de sesiones y filtrar por cliente
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-tab="sesiones"]').classList.add('active');
    
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById('sesiones-tab').classList.add('active');
    
    // Scroll a la tabla de sesiones
    setTimeout(() => {
        document.getElementById('sesiones-tab').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

function verArchivosCliente(clienteId) {
    // Cambiar al tab de archivos
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-tab="archivos"]').classList.add('active');
    
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById('archivos-tab').classList.add('active');
    
    // Scroll a la tabla de archivos
    setTimeout(() => {
        document.getElementById('archivos-tab').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

// Funci√≥n para cargar el panel de empleado en iframe
function cargarPanelEmpleadoIframe() {
    const container = document.getElementById('panel-empleado-container');
    container.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <span style="font-size: 24px;">‚è≥</span>
                <p>Cargando panel de empleado...</p>
            </div>
        </div>
    `;
    
    // Intentar cargar el iframe
    setTimeout(() => {
        container.innerHTML = `
            <iframe 
                src="{% url 'empleado_dashboard' %}" 
                style="width: 100%; height: 800px; border: none; border-radius: 8px;"
                title="Panel de Empleado"
                onload="iframeLoaded()"
                onerror="iframeError()"
            ></iframe>
        `;
    }, 500);
}

// Callback cuando el iframe carga correctamente
function iframeLoaded() {
    console.log('Panel de empleado cargado correctamente');
}

// Callback si hay error al cargar el iframe
function iframeError() {
    const container = document.getElementById('panel-empleado-container');
    container.innerHTML = `
        <div style="padding: 40px 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3 style="color: #dc3545; margin-bottom: 10px;">No se pudo cargar el panel</h3>
            <p style="color: #666; margin-bottom: 20px;">
                El navegador bloque√≥ la carga del panel integrado debido a pol√≠ticas de seguridad.
            </p>
            <a href="{% url 'empleado_dashboard' %}" target="_blank" class="btn-primary" style="display: inline-block; padding: 12px 24px; text-decoration: none;">
                üîó Abrir Panel en Nueva Pesta√±a
            </a>
        </div>
    `;
}

// B√∫squeda de clientes
document.addEventListener('DOMContentLoaded', function() {
    const buscarCliente = document.getElementById('buscar-cliente');
    if (buscarCliente) {
        buscarCliente.addEventListener('input', function() {
            const busqueda = this.value.toLowerCase();
            const clienteCards = document.querySelectorAll('.cliente-card');
            
            clienteCards.forEach(card => {
                const texto = card.textContent.toLowerCase();
                if (texto.includes(busqueda)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
    
    // Event listener para cambio de servicio en formulario de precios
    const servicioSelect = document.getElementById('servicio');
    if (servicioSelect) {
        servicioSelect.addEventListener('change', actualizarCamposSesiones);
    }
});

// Funci√≥n para generar sesiones de una orden
function generarSesiones(orderId) {
    if (!confirm('¬øEst√°s seguro de que deseas generar las sesiones para esta orden?')) {
        return;
    }

    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ Generando...';

    fetch(`/admin/orden/${orderId}/generar-sesiones/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.message);
            button.disabled = false;
            button.textContent = '‚ú® Generar Sesiones';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al generar sesiones');
        button.disabled = false;
        button.textContent = '‚ú® Generar Sesiones';
    });
}

// Funci√≥n para ver detalles de una orden
function verDetallesOrden(orderId) {
    alert(`Funci√≥n en desarrollo: Ver detalles de la orden #${orderId}`);
    // Aqu√≠ se podr√≠a abrir un modal con m√°s informaci√≥n
}

// Funci√≥n para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
