{% extends 'base.html' %}
{% load static %}

{% block title %}Panel Administrador - ImpulsaMente{% endblock %}

{% block body_class %}admin-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-dashboard.css' %}">
{% endblock %}

{% block content %}
<main class="admin-dashboard-main">
    <div class="container">
        <h1 class="dashboard-title">üõ†Ô∏è Panel de Administraci√≥n</h1>

        <!-- Tabs Navigation -->
        <div class="admin-tabs">
            <button class="admin-tab-btn active" data-tab="precios">üìä Precios</button>
            <button class="admin-tab-btn" data-tab="empleados">üë• Empleados</button>
            <button class="admin-tab-btn" data-tab="clientes">üë§ Clientes</button>
            <button class="admin-tab-btn" data-tab="asignaciones">üîó Asignaciones</button>
            <button class="admin-tab-btn" data-tab="sesiones">üìÖ Sesiones</button>
            <button class="admin-tab-btn" data-tab="archivos">üìÅ Archivos</button>
            <button class="admin-tab-btn" data-tab="auditoria">üîç Auditor√≠a</button>
            <button class="admin-tab-btn" data-tab="panel-empleado">üìã Panel Empleado</button>
        </div>

        <!-- Tab Content -->
        <div class="admin-tab-content">
            <!-- PRECIOS TAB -->
            <div class="tab-panel active" id="precios-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Precios</h2>
                    <button class="btn-primary" onclick="mostrarFormularioNuevoPrecio()">‚ûï Nuevo Precio</button>
                </div>

                <!-- Formulario Nuevo Precio -->
                <div id="formularioPrecio" class="form-container" style="display:none;">
                    <h3 id="formulario-titulo">Crear Nuevo Precio</h3>
                    <form id="precioForm" method="POST" action="{% url 'admin_create_price' %}">
                        {% csrf_token %}
                        <input type="hidden" id="precio_id" name="precio_id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="servicio">* Categor√≠a/Servicio</label>
                                <select id="servicio" name="servicio" required>
                                    <option value="">Selecciona una categor√≠a</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}">{{ service.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="plan">* Nombre del Plan</label>
                                <input type="text" id="plan" name="plan" required placeholder="Ej: Plan B√°sico">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="precio">* Precio</label>
                                <input type="number" id="precio" name="precio" step="0.01" required placeholder="0.00">
                            </div>

                            <div class="form-group">
                                <label for="moneda">* Moneda</label>
                                <select id="moneda" name="moneda" required>
                                    <option value="CLP">CLP - Peso Chileno</option>
                                    <option value="USD">USD - D√≥lar</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="descripcion">Descripci√≥n</label>
                            <textarea id="descripcion" name="descripcion" rows="3" placeholder="Describe las caracter√≠sticas del plan..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üíæ Guardar</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioPrecio()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Precios -->
                <div class="prices-list">
                    {% for service in services %}
                    <div class="service-prices-group">
                        <h3>{{ service.name }}</h3>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Plan</th>
                                        <th>Precio</th>
                                        <th>Descripci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for price in service.prices.all %}
                                    <tr id="price-row-{{ price.id }}">
                                        <td><strong>{{ price.plan }}</strong></td>
                                        <td>${{ price.price }} {{ price.currency }}</td>
                                        <td>{{ price.description|truncatewords:15 }}</td>
                                        <td>
                                            <button class="btn-icon" 
                                                onclick="editarPrecio({{ price.id }}, {{ price.service.id }}, '{{ price.plan|escapejs }}', {{ price.price }}, '{{ price.currency }}', '{{ price.description|escapejs }}')" 
                                                title="Editar">‚úèÔ∏è</button>
                                            <button class="btn-icon btn-danger" onclick="eliminarPrecio({{ price.id }})" title="Eliminar">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4">No hay precios definidos</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- EMPLEADOS TAB -->
            <div class="tab-panel" id="empleados-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Empleados</h2>
                    <button class="btn-primary" onclick="mostrarFormularioNuevoEmpleado()">‚ûï Nuevo Empleado</button>
                </div>

                <!-- Formulario Nuevo Empleado -->
                <div id="formularioEmpleado" class="form-container" style="display:none;">
                    <h3>Crear Cuenta de Empleado</h3>
                    <form id="empleadoForm" method="POST" action="{% url 'admin_create_employee' %}">
                        {% csrf_token %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="username">* Nombre de Usuario</label>
                                <input type="text" id="username" name="username" required>
                            </div>

                            <div class="form-group">
                                <label for="email">* Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="first_name">* Nombre</label>
                                <input type="text" id="first_name" name="first_name" required>
                            </div>

                            <div class="form-group">
                                <label for="last_name">* Apellido</label>
                                <input type="text" id="last_name" name="last_name" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="password1">* Contrase√±a</label>
                                <input type="password" id="password1" name="password1" required>
                                <small>M√≠n. 8 caracteres, incluir may√∫scula, min√∫scula, n√∫mero y caracter especial</small>
                            </div>

                            <div class="form-group">
                                <label for="password2">* Confirmar Contrase√±a</label>
                                <input type="password" id="password2" name="password2" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="grupo">* Rol/Grupo</label>
                            <select id="grupo" name="grupo" required>
                                <option value="">Selecciona un rol</option>
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="is_staff" value="1">
                                Dar permisos de staff (acceso al panel de empleado)
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üë§ Crear Empleado</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioEmpleado()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Empleados -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Grupo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td><strong>{{ employee.username }}</strong></td>
                                <td>{{ employee.get_full_name }}</td>
                                <td>{{ employee.email }}</td>
                                <td>
                                    {% for group in employee.groups.all %}
                                    <span class="badge">{{ group.name }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if employee.is_active %}
                                    <span class="status-badge status-active">Activo</span>
                                    {% else %}
                                    <span class="status-badge status-inactive">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verEmpleado({{ employee.id }})" title="Ver">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="toggleEstadoEmpleado({{ employee.id }})" title="Activar/Desactivar">üîÑ</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6">No hay empleados registrados</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES TAB -->
            <div class="tab-panel" id="clientes-tab">
                <div class="panel-header">
                    <h2>Gesti√≥n de Clientes y Progreso</h2>
                    <div class="filters">
                        <input type="text" id="buscar-cliente" placeholder="üîç Buscar cliente..." class="filter-select" style="width: 250px;">
                    </div>
                </div>

                <!-- Lista de Clientes con Progreso -->
                <div class="clientes-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
                    {% for client in clients %}
                    <div class="cliente-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                {{ client.first_name.0|default:client.username.0|upper }}
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #333; font-size: 1.1rem;">{{ client.get_full_name|default:client.username }}</h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">@{{ client.username }}</p>
                                <p style="margin: 5px 0 0 0; color: #999; font-size: 0.85rem;">{{ client.email }}</p>
                            </div>
                        </div>

                        <!-- Estad√≠sticas del Cliente -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Asignaciones</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #667eea;">
                                        {{ client.active_assignments_count }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Sesiones</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #28a745;">
                                        {{ client.total_sessions }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Archivos</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #ffc107;">
                                        {{ client.files_count }}
                                    </p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-size: 0.8rem; color: #666;">Actividad</p>
                                    <p style="margin: 5px 0 0 0; font-size: 1.3rem; font-weight: bold; color: #dc3545;">
                                        {{ client.audit_count }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Asignaciones del Cliente -->
                        <div style="margin-bottom: 12px;">
                            <p style="margin: 0 0 8px 0; font-weight: 600; color: #333; font-size: 0.9rem;">Asignado a:</p>
                            {% for assignment in client.client_assignments.all %}
                            {% if assignment.is_active %}
                            <div style="background: #e8f5e9; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 600; color: #2e7d32;">{{ assignment.employee.get_full_name }}</span>
                                    <span style="color: #666; font-size: 0.85rem;"> - {{ assignment.service.name }}</span>
                                </div>
                                <span class="status-badge status-active" style="font-size: 0.7rem;">Activa</span>
                            </div>
                            {% endif %}
                            {% empty %}
                            <p style="color: #999; font-size: 0.85rem; font-style: italic;">Sin asignaciones activas</p>
                            {% endfor %}
                        </div>

                        <!-- Acciones -->
                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem;" onclick="verProgresoCliente({{ client.id }})">
                                üìä Ver Progreso
                            </button>
                            <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 0.85rem;" onclick="verArchivosCliente({{ client.id }})">
                                üìÅ Ver Archivos
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <p style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">No hay clientes registrados</p>
                    {% endfor %}
                </div>
            </div>

            <!-- ASIGNACIONES TAB -->
            <div class="tab-panel" id="asignaciones-tab">
                <div class="panel-header">
                    <h2>Asignaci√≥n Cliente-Empleado</h2>
                    <button class="btn-primary" onclick="mostrarFormularioAsignacion()">‚ûï Nueva Asignaci√≥n</button>
                </div>

                <!-- Formulario Nueva Asignaci√≥n -->
                <div id="formularioAsignacion" class="form-container" style="display:none;">
                    <h3>Asignar Cliente a Empleado</h3>
                    <form id="asignacionForm" method="POST" action="{% url 'admin_create_assignment' %}">
                        {% csrf_token %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cliente">* Cliente</label>
                                <select id="cliente" name="cliente" required>
                                    <option value="">Selecciona un cliente</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.username }} - {{ client.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="empleado">* Empleado</label>
                                <select id="empleado" name="empleado" required>
                                    <option value="">Selecciona un empleado</option>
                                    {% for emp in employees %}
                                    <option value="{{ emp.id }}">{{ emp.username }} - {{ emp.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="servicio_asignacion">* Servicio</label>
                            <select id="servicio_asignacion" name="servicio" required>
                                <option value="">Selecciona un servicio</option>
                                {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="notas_asignacion">Notas</label>
                            <textarea id="notas_asignacion" name="notas" rows="3" placeholder="Informaci√≥n adicional sobre la asignaci√≥n..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üîó Crear Asignaci√≥n</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioAsignacion()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Asignaciones -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Empleado</th>
                                <th>Servicio</th>
                                <th>Fecha Asignaci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td><strong>{{ assignment.client.username }}</strong><br><small>{{ assignment.client.get_full_name }}</small></td>
                                <td><strong>{{ assignment.employee.username }}</strong><br><small>{{ assignment.employee.get_full_name }}</small></td>
                                <td>{{ assignment.service.name }}</td>
                                <td>{{ assignment.assigned_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if assignment.is_active %}
                                    <span class="status-badge status-active">Activa</span>
                                    {% else %}
                                    <span class="status-badge status-inactive">Inactiva</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verAsignacion({{ assignment.id }})" title="Ver">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="toggleAsignacion({{ assignment.id }})" title="Activar/Desactivar">üîÑ</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6">No hay asignaciones registradas</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SESIONES TAB -->
            <div class="tab-panel" id="sesiones-tab">
                <div class="panel-header">
                    <h2>Fechas de Sesiones</h2>
                    <button class="btn-primary" onclick="mostrarFormularioSesion()">‚ûï Nueva Sesi√≥n</button>
                </div>

                <!-- Formulario Nueva Sesi√≥n -->
                <div id="formularioSesion" class="form-container" style="display:none;">
                    <h3>Programar Nueva Sesi√≥n</h3>
                    <form id="sesionForm" method="POST" action="{% url 'admin_create_session' %}">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="asignacion">* Asignaci√≥n Cliente-Empleado</label>
                            <select id="asignacion" name="asignacion" required>
                                <option value="">Selecciona una asignaci√≥n</option>
                                {% for assignment in assignments %}
                                {% if assignment.is_active %}
                                <option value="{{ assignment.id }}">{{ assignment.client.username }} ‚Üí {{ assignment.employee.username }} ({{ assignment.service.name }})</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fecha">* Fecha</label>
                                <input type="date" id="fecha" name="fecha" required>
                            </div>

                            <div class="form-group">
                                <label for="hora">* Hora</label>
                                <input type="time" id="hora" name="hora" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="duracion">* Duraci√≥n (minutos)</label>
                                <input type="number" id="duracion" name="duracion" value="60" min="15" max="240" required>
                            </div>

                            <div class="form-group">
                                <label for="estado">* Estado</label>
                                <select id="estado" name="estado" required>
                                    <option value="scheduled">Programada</option>
                                    <option value="confirmed">Confirmada</option>
                                    <option value="completed">Completada</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notas_sesion">Notas</label>
                            <textarea id="notas_sesion" name="notas" rows="3" placeholder="Informaci√≥n sobre la sesi√≥n..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üìÖ Crear Sesi√≥n</button>
                            <button type="button" class="btn-secondary" onclick="ocultarFormularioSesion()">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Sesiones -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Cliente</th>
                                <th>Empleado</th>
                                <th>Servicio</th>
                                <th>Duraci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr>
                                <td><strong>{{ session.scheduled_date|date:"d/m/Y" }}</strong><br>{{ session.scheduled_date|time:"H:i" }}</td>
                                <td>{{ session.assignment.client.username }}</td>
                                <td>{{ session.assignment.employee.username }}</td>
                                <td>{{ session.assignment.service.name }}</td>
                                <td>{{ session.duration_minutes }} min</td>
                                <td>
                                    <span class="status-badge status-{{ session.status }}">{{ session.get_status_display }}</span>
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="verSesion({{ session.id }})" title="Ver">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="editarSesion({{ session.id }})" title="Editar">‚úèÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7">No hay sesiones programadas</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ARCHIVOS TAB -->
            <div class="tab-panel" id="archivos-tab">
                <div class="panel-header">
                    <h2>Archivos Compartidos</h2>
                    <div class="filters">
                        <select id="filtro-asignacion" class="filter-select">
                            <option value="">Todas las asignaciones</option>
                            {% for assignment in assignments %}
                            <option value="{{ assignment.id }}">{{ assignment.client.username }} - {{ assignment.employee.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Lista de Archivos -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Archivo</th>
                                <th>Tipo</th>
                                <th>Tama√±o</th>
                                <th>Subido Por</th>
                                <th>Cliente ‚Üí Empleado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr>
                                <td>
                                    <strong>{{ file.file_name }}</strong>
                                    {% if file.description %}
                                    <br><small>{{ file.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ file.get_file_type_display }}</td>
                                <td>{{ file.get_file_size_display }}</td>
                                <td>{{ file.uploaded_by.username }}</td>
                                <td>{{ file.assignment.client.username }} ‚Üí {{ file.assignment.employee.username }}</td>
                                <td>{{ file.uploaded_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <button class="btn-icon" onclick="descargarArchivo({{ file.id }})" title="Descargar">‚¨áÔ∏è</button>
                                    <button class="btn-icon btn-danger" onclick="eliminarArchivo({{ file.id }})" title="Eliminar">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7">No hay archivos compartidos</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AUDITOR√çA TAB -->
            <div class="tab-panel" id="auditoria-tab">
                <div class="panel-header">
                    <h2>Auditor√≠a de Clientes</h2>
                    <div class="filters">
                        <select id="filtro-usuario" class="filter-select">
                            <option value="">Todos los usuarios</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.username }} - {{ client.get_full_name }}</option>
                            {% endfor %}
                        </select>
                        <select id="filtro-accion" class="filter-select">
                            <option value="">Todas las acciones</option>
                            <option value="login">Inicio de Sesi√≥n</option>
                            <option value="logout">Cierre de Sesi√≥n</option>
                            <option value="order_created">Orden Creada</option>
                            <option value="session_completed">Sesi√≥n Completada</option>
                            <option value="file_uploaded">Archivo Subido</option>
                        </select>
                    </div>
                </div>

                <!-- Tabla de Auditor√≠a -->
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acci√≥n</th>
                                <th>Descripci√≥n</th>
                                <th>IP</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in audit_logs %}
                            <tr>
                                <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
                                <td><strong>{{ log.user.username }}</strong></td>
                                <td><span class="badge badge-{{ log.action }}">{{ log.get_action_display }}</span></td>
                                <td>{{ log.description|truncatewords:20 }}</td>
                                <td>{{ log.ip_address|default:"N/A" }}</td>
                                <td>
                                    <button class="btn-icon" onclick="verAuditoria({{ log.id }})" title="Ver">üëÅÔ∏è</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="6">No hay registros de auditor√≠a</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PANEL EMPLEADO TAB -->
            <div class="tab-panel" id="panel-empleado-tab">
                <div class="panel-header">
                    <h2>Vista de Panel Empleado (Auditor√≠a de Clientes)</h2>
                    <p style="color: #666; margin: 10px 0 0 0;">Vista completa del dashboard de empleado para supervisar estudiantes y solicitudes</p>
                </div>

                <!-- Panel de opciones -->
                <div style="background: white; border-radius: 12px; padding: 20px; min-height: 600px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <a href="{% url 'empleado_dashboard' %}" target="_blank" class="btn-primary" style="display: inline-block; padding: 12px 24px; text-decoration: none;">
                            üîó Abrir Panel de Empleado en Nueva Pesta√±a
                        </a>
                        <button class="btn-secondary" onclick="cargarPanelEmpleadoIframe()" style="padding: 12px 24px; margin-left: 10px;">
                            üîÑ Cargar Panel en Vista Integrada
                        </button>
                    </div>
                    
                    <div id="panel-empleado-container" style="border: 2px solid #e9ecef; border-radius: 8px; min-height: 500px; background: #f8f9fa;">
                        <div style="padding: 60px 20px; text-align: center; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                            <h3 style="color: #333; margin-bottom: 10px;">Panel de Empleado</h3>
                            <p>Opciones para acceder al panel de empleado:</p>
                            <ul style="list-style: none; padding: 0; margin: 20px 0; text-align: left; max-width: 500px; margin: 20px auto;">
                                <li style="padding: 10px 0;"><strong>üîó Nueva pesta√±a:</strong> Abre el panel completo en una ventana separada (Recomendado)</li>
                                <li style="padding: 10px 0;"><strong>üîÑ Vista integrada:</strong> Carga el panel dentro de esta p√°gina (puede tener limitaciones de navegador)</li>
                            </ul>
                            <p style="font-size: 0.9rem; margin-top: 15px; color: #999;">Aqu√≠ podr√°s auditar estudiantes, ver solicitudes y gestionar el progreso de los clientes</p>
                            
                            <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                                <strong>üí° Nota:</strong> Si la vista integrada no carga correctamente, usa la opci√≥n de "Nueva Pesta√±a"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin-dashboard.js' %}"></script>
<script>
// Funciones para mostrar/ocultar formularios
function mostrarFormularioNuevoPrecio() {
    document.getElementById('formularioPrecio').style.display = 'block';
    document.getElementById('formulario-titulo').textContent = 'Crear Nuevo Precio';
    document.getElementById('precioForm').reset();
    document.getElementById('precio_id').value = '';
    
    // Restaurar la acci√≥n del formulario a crear
    const form = document.getElementById('precioForm');
    form.action = '{% url "admin_create_price" %}';
    
    // Hacer scroll al formulario
    document.getElementById('formularioPrecio').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function ocultarFormularioPrecio() {
    document.getElementById('formularioPrecio').style.display = 'none';
    document.getElementById('precioForm').reset();
}

function mostrarFormularioNuevoEmpleado() {
    document.getElementById('formularioEmpleado').style.display = 'block';
    document.getElementById('empleadoForm').reset();
}

function ocultarFormularioEmpleado() {
    document.getElementById('formularioEmpleado').style.display = 'none';
}

function mostrarFormularioAsignacion() {
    document.getElementById('formularioAsignacion').style.display = 'block';
    document.getElementById('asignacionForm').reset();
}

function ocultarFormularioAsignacion() {
    document.getElementById('formularioAsignacion').style.display = 'none';
}

function mostrarFormularioSesion() {
    document.getElementById('formularioSesion').style.display = 'block';
    document.getElementById('sesionForm').reset();
}

function ocultarFormularioSesion() {
    document.getElementById('formularioSesion').style.display = 'none';
}

// Funciones de acciones
function editarPrecio(id, servicioId, plan, precio, moneda, descripcion) {
    // Mostrar el formulario
    mostrarFormularioNuevoPrecio();
    
    // Cambiar el t√≠tulo
    document.getElementById('formulario-titulo').textContent = 'Editar Precio';
    
    // Llenar el formulario con los datos existentes
    document.getElementById('precio_id').value = id;
    document.getElementById('servicio').value = servicioId;
    document.getElementById('plan').value = plan;
    document.getElementById('precio').value = precio;
    document.getElementById('moneda').value = moneda;
    document.getElementById('descripcion').value = descripcion;
    
    // Cambiar la acci√≥n del formulario
    const form = document.getElementById('precioForm');
    form.action = `/admin/precio/editar/${id}/`;
    
    // Hacer scroll al formulario
    document.getElementById('formularioPrecio').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function eliminarPrecio(id) {
    if(confirm('¬øEst√°s seguro de eliminar este precio? Esta acci√≥n no se puede deshacer.')) {
        window.location.href = `/admin/precio/eliminar/${id}/`;
    }
}

function verEmpleado(id) {
    alert('Ver empleado ID: ' + id);
}

function toggleEstadoEmpleado(id) {
    if(confirm('¬øCambiar el estado de este empleado (activar/desactivar)?')) {
        window.location.href = `/admin/empleado/toggle/${id}/`;
    }
}

function verAsignacion(id) {
    alert('Ver asignaci√≥n ID: ' + id + '\n\nEsta funcionalidad mostrar√° un modal con los detalles completos de la asignaci√≥n.');
}

function toggleAsignacion(id) {
    if(confirm('¬øCambiar el estado de esta asignaci√≥n (activar/desactivar)?')) {
        window.location.href = `/admin/asignacion/toggle/${id}/`;
    }
}

function verSesion(id) {
    alert('Ver sesi√≥n ID: ' + id + '\n\nEsta funcionalidad mostrar√° un modal con los detalles completos de la sesi√≥n.');
}

function editarSesion(id) {
    alert('Editar sesi√≥n ID: ' + id + '\n\nEsta funcionalidad permitir√° modificar la fecha, hora y estado de la sesi√≥n.');
}

function descargarArchivo(id) {
    alert('Descargar archivo ID: ' + id + '\n\nEsta funcionalidad descargar√° el archivo.');
    // window.location.href = `/admin/archivo/descargar/${id}/`;
}

function eliminarArchivo(id) {
    if(confirm('¬øEst√°s seguro de eliminar este archivo? Esta acci√≥n no se puede deshacer.')) {
        window.location.href = `/admin/archivo/eliminar/${id}/`;
    }
}

function verAuditoria(id) {
    alert('Ver detalles de auditor√≠a ID: ' + id + '\n\nEsta funcionalidad mostrar√° informaci√≥n detallada del registro de auditor√≠a.');
}

// Funciones para el tab de Clientes
function verProgresoCliente(clienteId) {
    // Cambiar al tab de sesiones y filtrar por cliente
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-tab="sesiones"]').classList.add('active');
    
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById('sesiones-tab').classList.add('active');
    
    // Scroll a la tabla de sesiones
    setTimeout(() => {
        document.getElementById('sesiones-tab').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

function verArchivosCliente(clienteId) {
    // Cambiar al tab de archivos
    document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-tab="archivos"]').classList.add('active');
    
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById('archivos-tab').classList.add('active');
    
    // Scroll a la tabla de archivos
    setTimeout(() => {
        document.getElementById('archivos-tab').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

// Funci√≥n para cargar el panel de empleado en iframe
function cargarPanelEmpleadoIframe() {
    const container = document.getElementById('panel-empleado-container');
    container.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <span style="font-size: 24px;">‚è≥</span>
                <p>Cargando panel de empleado...</p>
            </div>
        </div>
    `;
    
    // Intentar cargar el iframe
    setTimeout(() => {
        container.innerHTML = `
            <iframe 
                src="{% url 'empleado_dashboard' %}" 
                style="width: 100%; height: 800px; border: none; border-radius: 8px;"
                title="Panel de Empleado"
                onload="iframeLoaded()"
                onerror="iframeError()"
            ></iframe>
        `;
    }, 500);
}

// Callback cuando el iframe carga correctamente
function iframeLoaded() {
    console.log('Panel de empleado cargado correctamente');
}

// Callback si hay error al cargar el iframe
function iframeError() {
    const container = document.getElementById('panel-empleado-container');
    container.innerHTML = `
        <div style="padding: 40px 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h3 style="color: #dc3545; margin-bottom: 10px;">No se pudo cargar el panel</h3>
            <p style="color: #666; margin-bottom: 20px;">
                El navegador bloque√≥ la carga del panel integrado debido a pol√≠ticas de seguridad.
            </p>
            <a href="{% url 'empleado_dashboard' %}" target="_blank" class="btn-primary" style="display: inline-block; padding: 12px 24px; text-decoration: none;">
                üîó Abrir Panel en Nueva Pesta√±a
            </a>
        </div>
    `;
}

// B√∫squeda de clientes
document.addEventListener('DOMContentLoaded', function() {
    const buscarCliente = document.getElementById('buscar-cliente');
    if (buscarCliente) {
        buscarCliente.addEventListener('input', function() {
            const busqueda = this.value.toLowerCase();
            const clienteCards = document.querySelectorAll('.cliente-card');
            
            clienteCards.forEach(card => {
                const texto = card.textContent.toLowerCase();
                if (texto.includes(busqueda)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}
