{% extends 'base.html' %}
{% load static %}

{% block title %}Vista de Cliente - ImpulsaMente{% endblock %}

{% block body_class %}cliente-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cliente-dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
    <main class="dashboard-main">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1 style="color: #333; margin: 0;">üë§ Mi Dashboard</h1>
                <a href="{% url 'cliente_perfil' %}" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                    ‚öôÔ∏è Mi Perfil
                </a>
            </div>
            
            <div class="dashboard-grid">
                <!-- Progress Section -->
                <section class="progress-section">
                    <div class="progress-card">
                        <div class="progress-header">
                            <div class="progress-icon">
                                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                                    <circle cx="20" cy="20" r="18" stroke="#4CAF50" stroke-width="4" fill="none"/>
                                    <path d="M12 20l6 6 10-12" stroke="#4CAF50" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3>MI PROGRESO</h3>
                        </div>
                        
                        {% if total_sessions > 0 %}
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar" data-progress="{{ progress }}"></div>
                            </div>
                            <span class="progress-percentage">{{ progress }}%</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                            <div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #4CAF50;">{{ total_sessions }}</div>
                                <div style="font-size: 12px; color: #666;">Total Sesiones</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #2196F3;">{{ completed_sessions }}</div>
                                <div style="font-size: 12px; color: #666;">Completadas</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #FF9800;">{{ scheduled_sessions }}</div>
                                <div style="font-size: 12px; color: #666;">Programadas</div>
                            </div>
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üìö</div>
                            <p>A√∫n no tienes sesiones programadas</p>
                        </div>
                        {% endif %}
                    </div>
                </section>

                <!-- Assignments Section -->
                <section class="folders-section" style="background: white !important;">
                    <h3 style="margin-bottom: 15px; color: #333;">üë• Mis Asesor√≠as</h3>
                    <div style="display: block !important; gap: 15px; max-height: 400px; overflow-y: auto; padding-right: 5px;">
                        {% for assignment in assignments %}
                        <div style="display: block !important; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #4CAF50; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="font-size: 32px;">
                                    {% if assignment.service.slug == 'tutoria' %}üìö
                                    {% elif assignment.service.slug == 'terapia' %}üß†
                                    {% else %}üìÑ{% endif %}
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: #333;">{{ assignment.service.name }}</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                        Con: {{ assignment.employee.get_full_name|default:assignment.employee.username }}
                                    </p>
                                    <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">
                                        Desde: {{ assignment.assigned_at|date:"d/m/Y" }}
                                    </p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="openChatFromAssignment({{ assignment.id }})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease;">
                                    üí¨ Chat
                                </button>
                                <button onclick="showFilesModal({{ assignment.id }}, '{{ assignment.service.name }}', '{{ assignment.employee.get_full_name|default:assignment.employee.username }}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease;">
                                    üìÅ Archivos
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div style="text-align: center; padding: 40px; color: #999; background: white; border-radius: 12px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üë®‚Äçüè´</div>
                            <p>No tienes asesor√≠as asignadas a√∫n</p>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Chat Section -->
                <section class="folders-section" style="grid-column: span 2;">
                    <h3 style="margin-bottom: 15px; color: #333;">üí¨ Chat con mis Asesores</h3>
                    <div class="chat-container">
                        <div class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <h3>Conversaciones</h3>
                            </div>
                            <div class="chat-conversations-list" id="chatConversationsList">
                                <div style="padding: 20px; text-align: center; color: #a0aec0;">
                                    <p>Cargando conversaciones...</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-main" id="chatMainArea" style="display: none;">
                            <div class="chat-header">
                                <div class="chat-header-info">
                                    <h3>Selecciona una conversaci√≥n</h3>
                                    <p>Elige un asesor para comenzar a chatear</p>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessagesContainer">
                                <div class="chat-empty-state">
                                    <p>Selecciona una conversaci√≥n para ver los mensajes</p>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <textarea id="chatInput" class="chat-input" placeholder="Escribe tu mensaje..." rows="1"></textarea>
                                    <button id="sendMessageBtn" class="chat-send-btn">Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sessions Calendar -->
                <section class="calendar-section">
                    <div class="calendar-header">
                        <h3>üìÖ MIS SESIONES</h3>
                    </div>
                    
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 450px; overflow-y: auto; padding-right: 5px;">
                        {% if sessions %}
                            {% for session in sessions %}
                            <div style="display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; background: {% if session.status == 'completed' %}#e8f5e9{% elif session.status == 'cancelled' %}#ffebee{% else %}#e3f2fd{% endif %}; border-left: 4px solid {% if session.status == 'completed' %}#4CAF50{% elif session.status == 'cancelled' %}#f44336{% else %}#2196F3{% endif %};">
                                <div style="font-size: 32px;">
                                    {% if session.status == 'completed' %}‚úÖ
                                    {% elif session.status == 'cancelled' %}‚ùå
                                    {% else %}üìÖ{% endif %}
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; color: #333;">{{ session.assignment.service.name }}</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                        {{ session.scheduled_date|date:"d/m/Y" }} - {{ session.scheduled_date|time:"H:i" }}
                                    </p>
                                    <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">
                                        Con: {{ session.assignment.employee.get_full_name|default:session.assignment.employee.username }}
                                    </p>
                                </div>
                                <div style="padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; background: white;">
                                    {% if session.status == 'completed' %}Completada
                                    {% elif session.status == 'cancelled' %}Cancelada
                                    {% elif session.status == 'confirmed' %}Confirmada
                                    {% else %}Programada{% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                            <p>No tienes sesiones programadas</p>
                        </div>
                        {% endif %}
                    </div>
                </section>
            </div>

            <!-- Next Session Alert -->
            {% if next_session %}
            <div class="messages-section" style="margin-top: 30px;">
                <div class="message-card urgent" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 48px;">üîî</div>
                        <div>
                            <h4 style="margin: 0 0 8px 0; font-size: 18px;">¬°PR√ìXIMA SESI√ìN!</h4>
                            <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                                {{ next_session.assignment.service.name }} - 
                                {{ next_session.scheduled_date|date:"d/m/Y" }} a las {{ next_session.scheduled_date|time:"H:i" }}
                            </p>
                            {% if days_until_next is not None %}
                            <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">
                                {% if days_until_next == 0 %}
                                    ¬°Es hoy!
                                {% elif days_until_next == 1 %}
                                    Es ma√±ana
                                {% else %}
                                    En {{ days_until_next }} d√≠as
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Modal de Archivos -->
    <div id="filesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 24px;">üìÅ Archivos</h2>
                    <p id="filesModalSubtitle" style="margin: 0; font-size: 14px; opacity: 0.9;"></p>
                </div>
                <button onclick="closeFilesModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                    ‚úï
                </button>
            </div>
            <div style="padding: 25px; overflow-y: auto; flex: 1;">
                <div style="margin-bottom: 20px;">
                    <button id="uploadFileBtn" onclick="showUploadForm()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease;">
                        ‚¨ÜÔ∏è Subir Archivo
                    </button>
                </div>
                
                <div id="uploadFormContainer" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">Subir nuevo archivo</h4>
                    <form id="uploadFileForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="uploadAssignmentId" name="assignment_id">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Archivo:</label>
                            <input type="file" name="file" required style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; background: white;">
                            <small style="color: #666; display: block; margin-top: 5px;">M√°ximo 10MB</small>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Descripci√≥n:</label>
                            <input type="text" name="description" placeholder="Ej: Tarea de matem√°ticas" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button type="button" onclick="hideUploadForm()" style="background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cancelar
                            </button>
                            <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Subir
                            </button>
                        </div>
                    </form>
                </div>

                <div id="filesListContainer">
                    <!-- La lista de archivos se cargar√° aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cliente-dashboard.js' %}"></script>
<script>
// Variables globales para el modal de archivos
let currentAssignmentId = null;

// Funci√≥n para abrir el chat desde una asesor√≠a
function openChatFromAssignment(assignmentId) {
    if (typeof chatSystem !== 'undefined') {
        // Ocultar el modal de archivos si est√° abierto
        closeFilesModal();
        
        // Abrir la conversaci√≥n en el chat
        chatSystem.openConversation(assignmentId);
        
        // Hacer scroll al chat
        const chatSection = document.querySelector('.chat-container');
        if (chatSection) {
            chatSection.scrollIntoView({ behavior: 'smooth' });
        }
    }
}

// Funci√≥n para mostrar el modal de archivos
function showFilesModal(assignmentId, serviceName, employeeName) {
    currentAssignmentId = assignmentId;
    
    const modal = document.getElementById('filesModal');
    const subtitle = document.getElementById('filesModalSubtitle');
    
    subtitle.textContent = `${serviceName} con ${employeeName}`;
    modal.style.display = 'flex';
    
    // Cargar los archivos de esta asesor√≠a
    loadAssignmentFiles(assignmentId);
}

// Funci√≥n para cerrar el modal de archivos
function closeFilesModal() {
    document.getElementById('filesModal').style.display = 'none';
    hideUploadForm();
    currentAssignmentId = null;
}

// Funci√≥n para mostrar el formulario de subida
function showUploadForm() {
    document.getElementById('uploadFormContainer').style.display = 'block';
    document.getElementById('uploadAssignmentId').value = currentAssignmentId;
}

// Funci√≥n para ocultar el formulario de subida
function hideUploadForm() {
    document.getElementById('uploadFormContainer').style.display = 'none';
    document.getElementById('uploadFileForm').reset();
}

// Funci√≥n para cargar archivos de una asesor√≠a
async function loadAssignmentFiles(assignmentId) {
    const container = document.getElementById('filesListContainer');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">‚è≥ Cargando archivos...</div>';
    
    try {
        const response = await fetch(`/api/assignment/${assignmentId}/files/`);
        const data = await response.json();
        
        if (data.success) {
            if (data.files.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                        <p>No hay archivos a√∫n</p>
                        <p style="font-size: 14px;">Usa el bot√≥n "Subir Archivo" para agregar archivos</p>
                    </div>
                `;
            } else {
                container.innerHTML = data.files.map(file => `
                    <div class="archivo-item" data-file-id="${file.id}" style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 32px;">üìÑ</div>
                        <div style="flex: 1;">
                            <h5 style="margin: 0 0 5px 0; color: #333;">${escapeHtml(file.file_name)}</h5>
                            <p style="margin: 0; color: #666; font-size: 13px;">
                                ${file.description ? escapeHtml(file.description) + ' ‚Ä¢ ' : ''}
                                ${file.file_size} ‚Ä¢ 
                                Subido por ${escapeHtml(file.uploaded_by)} ‚Ä¢ 
                                ${file.uploaded_at}
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <a href="${file.file_url}" download style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                                ‚¨áÔ∏è Descargar
                            </a>
                            ${file.can_delete ? `
                            <button onclick="deleteFile(${file.id}, '${escapeHtml(file.file_name)}')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                üóëÔ∏è Eliminar
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <p>Error al cargar archivos</p>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }
}

// Funci√≥n para eliminar archivo desde el modal
async function deleteFile(fileId, fileName) {
    if (!confirm(`¬øEst√°s seguro de que deseas eliminar "${fileName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/file/delete/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Recargar la lista de archivos
            loadAssignmentFiles(currentAssignmentId);
            alert('‚úÖ Archivo eliminado exitosamente');
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Error al eliminar archivo: ' + error.message);
    }
}

// Manejar env√≠o del formulario de subida desde el modal
document.getElementById('uploadFileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Subiendo...';
    
    try {
        const response = await fetch('{% url "upload_file" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Archivo subido exitosamente');
            hideUploadForm();
            loadAssignmentFiles(currentAssignmentId);
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Error al subir archivo: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Subir';
    }
});

// Funci√≥n helper para escapar HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Cerrar modal al hacer clic fuera
document.getElementById('filesModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFilesModal();
    }
});
</script>
<script src="{% static 'js/chat.js' %}"></script>
{% endblock %}