{% extends 'base.html' %}
{% load static %}

{% block title %}Panel Empleado - ImpulsaMente{% endblock %}

{% block body_class %}empleado-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/empleado-dashboard.css' %}?v=3.0">
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
    <main class="dashboard-main">
        <div class="container">
            <!-- Tabs Navigation -->
            <div class="tabs-navigation">
                <button class="tab-btn active" data-tab="estudiantes">ESTUDIANTES</button>
                <button class="tab-btn" data-tab="chat">üí¨ CHAT</button>
                <button class="tab-btn" data-tab="solicitudes">SOLICITUDES</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content-wrapper">
                <!-- Estudiantes Tab -->
                <div class="tab-content active" id="estudiantes-tab">
                    <div class="estudiantes-grid">
                        {% if clients_data %}
                            {% for client_info in clients_data %}
                            <!-- Client Card -->
                            <div class="student-card">
                                <div class="student-avatar">
                                    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold;">
                                        {{ client_info.client.first_name|first|default:client_info.client.username|first|upper }}
                                    </div>
                                </div>
                                <div class="student-info">
                                    <div class="student-badges">
                                        <span class="badge estudiante-badge">CLIENTE</span>
                                        <span class="badge datos-badge">{{ client_info.service.name|upper }}</span>
                                    </div>
                                    <div class="student-name" style="margin: 10px 0; font-weight: 600; font-size: 16px;">
                                        {% if client_info.client.first_name %}
                                            {{ client_info.client.first_name }} {{ client_info.client.last_name }}
                                        {% else %}
                                            {{ client_info.client.username }}
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        {{ client_info.client.email }}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                        üìÖ Sesiones: {{ client_info.completed_sessions }}/{{ client_info.total_sessions }}
                                    </div>
                                    <div class="progress-section">
                                        <div class="progress-header">
                                            <span class="progress-label">PROGRESO</span>
                                            <div class="action-buttons">
                                                <button class="ver-btn" onclick="verDetalleCliente({{ client_info.client.id }})">VER</button>
                                                <button class="auditoria-btn" onclick="window.location.href='{% url 'auditoria_estudiante' %}?client={{ client_info.client.id }}'">AUDITOR√çA</button>
                                                <button class="btn-ver-archivos" data-client-id="{{ client_info.client.id }}">ARCHIVOS</button>
                                            </div>
                                        </div>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-bg">
                                                <div class="progress-bar" data-progress="{{ client_info.progress }}" style="width: {{ client_info.progress }}%;"></div>
                                            </div>
                                            <span style="font-size: 12px; color: #667eea; font-weight: 600; margin-top: 5px;">{{ client_info.progress }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Mensaje cuando no hay clientes asignados -->
                            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üë•</div>
                                <h3 style="color: #666; margin-bottom: 10px;">No tienes clientes asignados</h3>
                                <p style="color: #999;">Cuando se te asignen clientes, aparecer√°n aqu√≠ con su informaci√≥n y progreso.</p>
                            </div>
                        {% endif %}
                        <div class="student-card">
                            <div class="student-avatar">
                                <img src="{% static 'images/personal/rubio.png' %}" alt="Pedro Rodr√≠guez" class="avatar-img">
                            </div>
                            <div class="student-info">
                                <div class="student-badges">
                                    <span class="badge estudiante-badge">ESTUDIANTE</span>
                                    <span class="badge datos-badge">DATOS</span>
                                </div>
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <span class="progress-label">PROGRESO DE TESIS</span>
                                        <button class="ver-btn">VER</button>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-bg">
                                            <div class="progress-bar" data-progress="60"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Tab -->
                <div class="tab-content" id="chat-tab">
                    <div class="chat-container">
                        <div class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <h3>üí¨ Conversaciones</h3>
                                <span class="unread-badge" id="unreadBadge">0</span>
                            </div>
                            <div class="conversations-list" id="chatConversationsList">
                                <!-- Las conversaciones se cargar√°n aqu√≠ din√°micamente -->
                            </div>
                        </div>
                        <div class="chat-main">
                            <div class="chat-header">
                                <div id="chatHeaderInfo">
                                    <h3>Selecciona una conversaci√≥n</h3>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessagesContainer">
                                <!-- Los mensajes se cargar√°n aqu√≠ -->
                            </div>
                            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                                <input type="text" id="chatInput" placeholder="Escribe un mensaje..." />
                                <button id="sendMessageBtn">Enviar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Solicitudes Tab -->
                <div class="tab-content" id="solicitudes-tab">
                    <div class="solicitudes-container">
                        <div class="solicitudes-header">
                            <h3>Nuevas Solicitudes de Asesor√≠a</h3>
                            <span class="solicitudes-count">{{ pending_requests_count }} pendiente{{ pending_requests_count|pluralize }}</span>
                        </div>
                        
                        <div class="solicitudes-list">
                            {% if pending_requests %}
                                {% for order in pending_requests %}
                                <div class="solicitud-item" data-order-id="{{ order.id }}">
                                    <div class="solicitud-info">
                                        <div class="solicitud-avatar">
                                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                                {{ order.customer.name|first|upper }}
                                            </div>
                                        </div>
                                        <div class="solicitud-details">
                                            <h4>{{ order.customer.name }}</h4>
                                            <p>
                                                <strong>{{ order.service.name }}</strong> - {{ order.price.plan }}
                                                {% if order.notes %}
                                                <br><span style="font-size: 13px; color: #666;">{{ order.notes|truncatewords:15 }}</span>
                                                {% endif %}
                                            </p>
                                            <span class="solicitud-time">
                                                {{ order.created_at|timesince }} atr√°s
                                                {% if order.start_date %}
                                                    ‚Ä¢ Inicio: {{ order.start_date|date:"d/m/Y" }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="solicitud-actions">
                                        <button class="accept-btn" onclick="acceptRequest({{ order.id }})">Aceptar</button>
                                        <button class="decline-btn" onclick="rejectRequest({{ order.id }})">Rechazar</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìã</div>
                                    <h3 style="color: #666; margin-bottom: 10px;">No hay solicitudes pendientes</h3>
                                    <p style="color: #999;">Cuando el administrador te asigne nuevas solicitudes, aparecer√°n aqu√≠.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Archivos Tab - ELIMINADO, ahora se accede desde bot√≥n en tarjeta de estudiante -->
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Folders Section -->
                <section class="folders-section">
                    <div class="folders-grid">
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Plantillas</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Recursos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Evaluaciones</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Reportes</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Metodolog√≠as</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Formatos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Cronogramas</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Bibliograf√≠a</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Ejemplos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Normas APA</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Instrumentos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Estad√≠sticas</span>
                        </div>
                    </div>
                </section>

                <!-- Calendar Section -->
                <section class="calendar-section">
                    <div class="calendar-header">
                        <h3>Agenda de Citas</h3>
                        <div class="calendar-controls">
                            <select class="month-select">
                                <option value="9">octubre</option>
                                <option value="10">noviembre</option>
                                <option value="11">diciembre</option>
                            </select>
                            <select class="year-select">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                            <button class="calendar-nav" data-dir="prev">‚Äπ</button>
                            <button class="calendar-nav" data-dir="next">‚Ä∫</button>
                        </div>
                    </div>
                    
                    <div class="calendar-location">Am√©rica/Santiago</div>
                    
                    <div class="calendar-grid">
                        <div class="calendar-header-days">
                            <div>lun</div>
                            <div>mar</div>
                            <div>mi√©</div>
                            <div>jue</div>
                            <div>vie</div>
                            <div>s√°b</div>
                            <div>dom</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Days will be generated by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{{ total_clients|default:0 }}</h4>
                        <p>Clientes Activos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{% if clients_data %}{{ clients_data|length }}{% else %}0{% endif %}</h4>
                        <p>Con Sesiones</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{% if clients_data %}{% for c in clients_data %}{{ c.completed_sessions|add:0 }}{% if not forloop.last %}+{% endif %}{% endfor %}{% else %}0{% endif %}</h4>
                        <p>Sesiones Completadas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>8</h4>
                        <p>Citas Esta Semana</p>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de Archivos Compartidos -->
            <div style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #333; font-size: 20px;">üìÅ Archivos Compartidos</h3>
                    <button onclick="mostrarFormularioSubirArchivo()" class="btn-primary" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span>üì§</span> Compartir Archivo
                    </button>
                </div>

                <!-- Formulario para subir archivos -->
                <div id="formularioSubirArchivo" style="display: none; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px dashed #4CAF50;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">üì§ Compartir Archivo con Cliente</h4>
                    <form id="uploadFileForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">* Cliente</label>
                                <select name="assignment_id" id="assignment_id" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                    <option value="">Selecciona un cliente</option>
                                    {% for client_data in clients_data %}
                                    <option value="{{ client_data.assignment.id }}">
                                        {{ client_data.client.get_full_name }} - {{ client_data.service.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">* Archivo</label>
                                <input type="file" name="file" id="file" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <small style="color: #666; margin-top: 5px; display: block;">
                                    Formatos permitidos: PDF, DOC, DOCX, TXT, JPG, PNG, MP3, MP4, ZIP (m√°x. 10MB)
                                </small>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">Descripci√≥n</label>
                                <textarea name="description" id="description" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Descripci√≥n opcional del archivo..."></textarea>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="ocultarFormularioSubirArchivo()" style="padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Cancelar
                                </button>
                                <button type="submit" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span>üì§</span> Compartir
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Lista de archivos -->
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div id="listaArchivos" style="display: grid; gap: 10px;">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                            <p>Cargando archivos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Detalles del Cliente -->
    <div id="clientModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; position: relative;">
                <h2 id="modalClientName" style="margin: 0; font-size: 24px; font-weight: 600;">Detalles del Cliente</h2>
                <button onclick="closeModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; font-weight: bold; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div id="modalContent">
                    <div style="text-align: center; padding: 40px 0;">
                        <div style="font-size: 48px; animation: spin 1s linear infinite;">‚è≥</div>
                        <p style="color: #666; margin-top: 15px;">Cargando informaci√≥n...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: center;">
                <button onclick="closeModal()" style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;">Cerrar</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .modal-content button:hover {
            background: rgba(255,255,255,0.3) !important;
        }
        .modal-footer button:hover {
            background: #5568d3 !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/empleado-dashboard.js' %}?v=13.0"></script>
<script src="{% static 'js/chat.js' %}"></script>
<script>
// FORZAR actualizaci√≥n de barras de progreso al cargar la p√°gina
window.addEventListener('load', function() {
    const progressBars = document.querySelectorAll('.student-card .progress-bar');
    progressBars.forEach((bar) => {
        const correctProgress = bar.getAttribute('data-progress');
        if (correctProgress) {
            bar.style.setProperty('width', correctProgress + '%', 'important');
        }
    });
});

function verDetalleCliente(clientId) {
    document.getElementById('clientModal').style.display = 'block';
    
    fetch(`/api/client/${clientId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modalClientName').textContent = `Detalles de ${data.client.name}`;
                
                let lastSessionText = 'No hay sesiones registradas';
                if (data.last_session_days !== null) {
                    if (data.last_session_days === 0) {
                        lastSessionText = 'Hoy';
                    } else if (data.last_session_days === 1) {
                        lastSessionText = 'Hace 1 d√≠a';
                    } else {
                        lastSessionText = `Hace ${data.last_session_days} d√≠as`;
                    }
                }
                
                const modalContent = `
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold;">
                            ${data.client.name.charAt(0).toUpperCase()}
                        </div>
                        <h3 style="margin: 0; font-size: 20px; color: #333;">${data.client.name}</h3>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">${data.client.email}</p>
                        ${data.client.phone ? `<p style="color: #666; font-size: 13px; margin: 3px 0 0 0;">üìû ${data.client.phone}</p>` : ''}
                        ${data.client.address ? `<p style="color: #666; font-size: 13px; margin: 3px 0 0 0;">üìç ${data.client.address}</p>` : ''}
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600; color: #333;">Progreso actual:</span>
                            <span style="font-size: 18px; font-weight: bold; color: #667eea;">${data.progress}%</span>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${data.progress}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üìÖ</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">√öltima sesi√≥n:</div>
                                <div style="font-weight: 600; color: #333;">${lastSessionText}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üóìÔ∏è</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Pr√≥xima cita:</div>
                                <div style="font-weight: 600; color: #333;">${data.next_appointment || 'No programada'}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üìä</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Estado:</div>
                                <div style="font-weight: 600; color: ${data.status === 'Activo' ? '#28a745' : '#dc3545'};">${data.status}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">‚úÖ</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Sesiones completadas:</div>
                                <div style="font-weight: 600; color: #333;">${data.completed_sessions} de ${data.total_sessions}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContent').innerHTML = modalContent;
            } else {
                document.getElementById('modalContent').innerHTML = `
                    <div style="text-align: center; padding: 40px 0; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p>Error al cargar los datos del cliente</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modalContent').innerHTML = `
                <div style="text-align: center; padding: 40px 0; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                    <p>Error de conexi√≥n. Por favor, intenta de nuevo.</p>
                </div>
            `;
        });
}

function closeModal() {
    document.getElementById('clientModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('clientModal');
    if (event.target == modal) {
        closeModal();
    }
}

// ============= FUNCIONES DE GESTI√ìN DE ARCHIVOS =============

function mostrarFormularioSubirArchivo() {
    document.getElementById('formularioSubirArchivo').style.display = 'block';
    document.getElementById('formularioSubirArchivo').scrollIntoView({ behavior: 'smooth' });
}

function ocultarFormularioSubirArchivo() {
    document.getElementById('formularioSubirArchivo').style.display = 'none';
    document.getElementById('uploadFileForm').reset();
}

// Manejar env√≠o del formulario de subida de archivos
document.getElementById('uploadFileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>‚è≥</span> Subiendo...';
    
    try {
        const response = await fetch('{% url "upload_file" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Archivo compartido exitosamente');
            ocultarFormularioSubirArchivo();
            cargarArchivos(); // Recargar lista de archivos
        } else {
            alert('‚ùå Error: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üì§</span> Compartir';
        }
    } catch (error) {
        alert('‚ùå Error al subir archivo: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>üì§</span> Compartir';
    }
});

async function cargarArchivos() {
    try {
        const response = await fetch('{% url "list_files" %}');
        const data = await response.json();
        
        const listaArchivos = document.getElementById('listaArchivos');
        
        if (data.success && data.files.length > 0) {
            listaArchivos.innerHTML = data.files.map(file => {
                let icon = 'üìé';
                if (file.file_type === 'document') icon = 'üìÑ';
                else if (file.file_type === 'image') icon = 'üñºÔ∏è';
                else if (file.file_type === 'audio') icon = 'üéµ';
                else if (file.file_type === 'video') icon = 'üé¨';
                
                return `
                    <div class="archivo-item" data-file-id="${file.id}" style="display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #e0e0e0;">
                        <div style="font-size: 28px;">${icon}</div>
                        <div style="flex: 1;">
                            <h5 style="margin: 0 0 5px 0; color: #333; font-size: 15px;">${file.file_name}</h5>
                            <p style="margin: 0; color: #666; font-size: 13px;">
                                ${file.file_size} ‚Ä¢ Subido por ${file.uploaded_by}
                            </p>
                            <p style="margin: 3px 0 0 0; color: #999; font-size: 12px;">
                                ${file.uploaded_at} ‚Ä¢ Para: ${file.assignment_client} (${file.assignment_service})
                            </p>
                            ${file.description ? `<p style="margin: 5px 0 0 0; color: #555; font-size: 12px; font-style: italic;">"${file.description}"</p>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <a href="/api/file/download/${file.id}/" class="btn-secondary" style="padding: 8px 15px; text-decoration: none; border-radius: 6px; font-size: 13px; background: #2196F3; color: white; display: flex; align-items: center; gap: 5px;">
                                <span>‚¨áÔ∏è</span> Descargar
                            </a>
                            ${file.can_delete ? `
                            <button onclick="eliminarArchivo(${file.id}, '${file.file_name.replace(/'/g, "\\'")}')" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                                <span>üóëÔ∏è</span> Eliminar
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            listaArchivos.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                    <p>No hay archivos compartidos a√∫n</p>
                    <p style="font-size: 14px; color: #666;">Usa el bot√≥n "Compartir Archivo" para enviar documentos a tus clientes</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error al cargar archivos:', error);
    }
}

async function eliminarArchivo(fileId, fileName) {
    if (!confirm(`¬øEst√°s seguro de que deseas eliminar "${fileName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/file/delete/${fileId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Archivo eliminado exitosamente');
            cargarArchivos(); // Recargar lista
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Error al eliminar archivo: ' + error.message);
    }
}

// Cargar archivos al cargar la p√°gina
window.addEventListener('DOMContentLoaded', function() {
    cargarArchivos();
});
</script>
{% endblock %}