{% extends 'base.html' %}
{% load static %}

{% block title %}Panel Psic√≥logo - ImpulsaMente{% endblock %}

{% block body_class %}psicologo-dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/psicologo-dashboard.css' %}?v=4.0">
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
    <main class="dashboard-main">
        <div class="container">
            <!-- Tabs Navigation -->
            <div class="tabs-navigation">
                <button class="tab-btn active" data-tab="estudiantes">ESTUDIANTES</button>
                <button class="tab-btn" data-tab="chat">üí¨ CHAT</button>
                <button class="tab-btn" data-tab="solicitudes">SOLICITUDES</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content-wrapper">
                <!-- Estudiantes Tab -->
                <div class="tab-content active" id="estudiantes-tab">
                    <!-- Filtros y Ordenamiento -->
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <form method="GET" action="" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 250px;">
                                <input 
                                    type="text" 
                                    name="search" 
                                    placeholder="üîç Buscar por nombre o email..." 
                                    value="{{ search_query }}"
                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                                    onfocus="this.style.borderColor='#667eea'"
                                    onblur="this.style.borderColor='#e0e0e0'"
                                >
                            </div>
                            <div style="flex: 0 0 auto;">
                                <select 
                                    name="order_by" 
                                    onchange="this.form.submit()"
                                    style="padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 200px;"
                                >
                                    <option value="recent_activity" {% if order_by == 'recent_activity' %}selected{% endif %}>üìÖ Actividad Reciente</option>
                                    <option value="next_appointment" {% if order_by == 'next_appointment' %}selected{% endif %}>üóìÔ∏è Pr√≥xima Cita</option>
                                    <option value="name" {% if order_by == 'name' %}selected{% endif %}>üî§ Nombre A-Z</option>
                                    <option value="progress" {% if order_by == 'progress' %}selected{% endif %}>üìä Mayor Progreso</option>
                                    <option value="new_files" {% if order_by == 'new_files' %}selected{% endif %}>üìÅ Archivos Nuevos</option>
                                </select>
                            </div>
                            <div style="flex: 0 0 auto;">
                                <button 
                                    type="submit" 
                                    style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'"
                                    onmouseout="this.style.transform='translateY(0)'"
                                >
                                    Buscar
                                </button>
                            </div>
                            {% if search_query %}
                            <div style="flex: 0 0 auto;">
                                <a 
                                    href="{% url 'psicologo_dashboard' %}" 
                                    style="padding: 12px 24px; background: #f0f0f0; color: #666; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-block; transition: background 0.2s;"
                                    onmouseover="this.style.background='#e0e0e0'"
                                    onmouseout="this.style.background='#f0f0f0'"
                                >
                                    Limpiar
                                </a>
                            </div>
                            {% endif %}
                        </form>
                        {% if search_query %}
                        <div style="margin-top: 12px; color: #667eea; font-size: 14px;">
                            üìã Mostrando {{ clients_data|length }} resultado(s) para "{{ search_query }}"
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="estudiantes-grid">
                        {% if clients_data %}
                            {% for client_info in clients_data %}
                            <!-- Client Card -->
                            <div class="student-card">
                                <div class="student-avatar">
                                    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold;">
                                        {{ client_info.client.first_name|first|default:client_info.client.username|first|upper }}
                                    </div>
                                </div>
                                <div class="student-info">
                                    <div class="student-badges">
                                        <span class="badge estudiante-badge">CLIENTE</span>
                                        <span class="badge datos-badge">{{ client_info.service.name|upper }}</span>
                                        {% if client_info.recent_files_count > 0 %}
                                        <span class="badge" style="background: #ff6b6b; color: white; animation: pulse 2s infinite;">üìÅ {{ client_info.recent_files_count }} nuevo(s)</span>
                                        {% endif %}
                                    </div>
                                    <div class="student-name" style="margin: 10px 0; font-weight: 600; font-size: 16px;">
                                        {% if client_info.client.first_name %}
                                            {{ client_info.client.first_name }} {{ client_info.client.last_name }}
                                        {% else %}
                                            {{ client_info.client.username }}
                                        {% endif %}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                        {{ client_info.client.email }}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-bottom: 5px;">
                                        üìÖ Sesiones: {{ client_info.completed_sessions }}/{{ client_info.total_sessions }}
                                    </div>
                                    {% if client_info.next_appointment %}
                                    <div style="font-size: 12px; color: #667eea; margin-bottom: 5px; font-weight: 500;">
                                        üóìÔ∏è Pr√≥xima: {{ client_info.next_appointment.scheduled_date|date:"d/m/Y H:i" }}
                                    </div>
                                    {% endif %}
                                    {% if client_info.last_activity %}
                                    <div style="font-size: 11px; color: #999; margin-bottom: 10px;">
                                        ‚è∞ √öltima actividad: {{ client_info.last_activity|timesince }} atr√°s
                                    </div>
                                    {% endif %}
                                    <div class="progress-section">
                                        <div class="progress-header">
                                            <span class="progress-label">PROGRESO</span>
                                            <div class="action-buttons">
                                                <button class="ver-btn" onclick="verDetalleCliente({{ client_info.client.id }})">VER</button>
                                                <button class="auditoria-btn" onclick="window.location.href='{% url 'auditoria_estudiante' %}?client={{ client_info.client.id }}'">AUDITOR√çA</button>
                                                <button class="btn-ver-archivos" data-client-id="{{ client_info.client.id }}">ARCHIVOS</button>
                                            </div>
                                        </div>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-bg">
                                                <div class="progress-bar" data-progress="{{ client_info.progress }}" style="width: {{ client_info.progress }}%;"></div>
                                            </div>
                                            <span style="font-size: 12px; color: #667eea; font-weight: 600; margin-top: 5px;">{{ client_info.progress }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Mensaje cuando no hay clientes asignados -->
                            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                                <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üë•</div>
                                <h3 style="color: #666; margin-bottom: 10px;">No tienes clientes asignados</h3>
                                <p style="color: #999;">Cuando se te asignen clientes, aparecer√°n aqu√≠ con su informaci√≥n y progreso.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Chat Tab -->
                <div class="tab-content" id="chat-tab">
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 10px 0; color: #333;">üí¨ Chat con Clientes</h3>
                        <p style="margin: 0; color: #666; font-size: 14px;">Comun√≠cate directamente con tus clientes asignados y comparte archivos.</p>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <h3>Mis Clientes</h3>
                            </div>
                            <div class="chat-conversations-list" id="chatConversationsList">
                                <div style="padding: 20px; text-align: center; color: #a0aec0;">
                                    <p>Cargando conversaciones...</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-main" id="chatMainArea" style="display: none;">
                            <div class="chat-header">
                                <div class="chat-header-info">
                                    <h3>Selecciona un cliente</h3>
                                    <p>Elige un cliente para comenzar a chatear</p>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessagesContainer">
                                <div class="chat-empty-state">
                                    <p>Selecciona una conversaci√≥n para ver los mensajes</p>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <div class="chat-input-wrapper">
                                    <textarea id="chatInput" class="chat-input" placeholder="Escribe tu mensaje..." rows="1"></textarea>
                                    <button id="sendMessageBtn" class="chat-send-btn">Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Solicitudes Tab -->
                <div class="tab-content" id="solicitudes-tab">
                    <div class="solicitudes-container">
                        <div class="solicitudes-header">
                            <h3>Nuevas Solicitudes de Asesor√≠a</h3>
                            <span class="solicitudes-count">{{ pending_requests_count }} pendiente{{ pending_requests_count|pluralize }}</span>
                        </div>
                        
                        <div class="solicitudes-list">
                            {% if pending_requests %}
                                {% for order in pending_requests %}
                                <div class="solicitud-item" data-order-id="{{ order.id }}">
                                    <div class="solicitud-info">
                                        <div class="solicitud-avatar">
                                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                                {{ order.customer.name|first|upper }}
                                            </div>
                                        </div>
                                        <div class="solicitud-details">
                                            <h4>{{ order.customer.name }}</h4>
                                            <p>
                                                <strong>{{ order.service.name }}</strong> - {{ order.price.plan }}
                                                {% if order.notes %}
                                                <br><span style="font-size: 13px; color: #666;">{{ order.notes|truncatewords:15 }}</span>
                                                {% endif %}
                                            </p>
                                            <span class="solicitud-time">
                                                {{ order.created_at|timesince }} atr√°s
                                                {% if order.start_date %}
                                                    ‚Ä¢ Inicio: {{ order.start_date|date:"d/m/Y" }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="solicitud-actions">
                                        <button class="accept-btn" onclick="acceptRequest({{ order.id }})">Aceptar</button>
                                        <button class="decline-btn" onclick="rejectRequest({{ order.id }})">Rechazar</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìã</div>
                                    <h3 style="color: #666; margin-bottom: 10px;">No hay solicitudes pendientes</h3>
                                    <p style="color: #999;">Cuando el administrador te asigne nuevas solicitudes, aparecer√°n aqu√≠.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Archivos Tab - ELIMINADO, ahora se accede desde bot√≥n en tarjeta de estudiante -->
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Folders Section -->
                <section class="folders-section">
                    <div class="folders-grid">
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Plantillas</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Recursos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Evaluaciones</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Reportes</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Metodolog√≠as</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Formatos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Cronogramas</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Bibliograf√≠a</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Ejemplos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Normas APA</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Instrumentos</span>
                        </div>
                        <div class="folder-item">
                            <div class="folder-icon">üìÅ</div>
                            <span>Estad√≠sticas</span>
                        </div>
                    </div>
                </section>

                <!-- Calendar Section -->
                <section class="calendar-section">
                    <div class="calendar-header">
                        <h3>Agenda de Citas</h3>
                        <div class="calendar-controls">
                            <select class="month-select">
                                <option value="9">octubre</option>
                                <option value="10">noviembre</option>
                                <option value="11">diciembre</option>
                            </select>
                            <select class="year-select">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                            <button class="calendar-nav" data-dir="prev">‚Äπ</button>
                            <button class="calendar-nav" data-dir="next">‚Ä∫</button>
                        </div>
                    </div>
                    
                    <div class="calendar-location">Am√©rica/Santiago</div>
                    
                    <div class="calendar-grid">
                        <div class="calendar-header-days">
                            <div>lun</div>
                            <div>mar</div>
                            <div>mi√©</div>
                            <div>jue</div>
                            <div>vie</div>
                            <div>s√°b</div>
                            <div>dom</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Days will be generated by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{{ total_clients|default:0 }}</h4>
                        <p>Clientes Activos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{% widthratio clients_data|length 1 clients_data|length %}{% if clients_data %}{{ clients_data.0.progress|default:0 }}{% else %}0{% endif %}%</h4>
                        <p>Progreso Promedio</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>{% for client in clients_data %}{% if client.progress >= 100 %}1{% endif %}{% endfor %}</h4>
                        <p>Sesiones Completadas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-info">
                        <h4>8</h4>
                        <p>Citas Esta Semana</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Detalles del Cliente -->
    <div id="clientModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; position: relative;">
                <h2 id="modalClientName" style="margin: 0; font-size: 24px; font-weight: 600;">Detalles del Cliente</h2>
                <button onclick="closeModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; font-weight: bold; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div id="modalContent">
                    <div style="text-align: center; padding: 40px 0;">
                        <div style="font-size: 48px; animation: spin 1s linear infinite;">‚è≥</div>
                        <p style="color: #666; margin-top: 15px;">Cargando informaci√≥n...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: center;">
                <button onclick="closeModal()" style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s;">Cerrar</button>
            </div>
        </div>
    </div>

    <style>
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        .modal-content button:hover {
            background: rgba(255,255,255,0.3) !important;
        }
        .modal-footer button:hover {
            background: #5568d3 !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/psicologo-dashboard.js' %}?v=13.0"></script>
<script src="{% static 'js/chat.js' %}"></script>
<script>
// Funci√≥n para ver detalles del cliente
function verDetalleCliente(clientId) {
    // Mostrar modal
    document.getElementById('clientModal').style.display = 'block';
    
    // Hacer petici√≥n AJAX para obtener datos del cliente
    fetch(`/api/client/${clientId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar nombre del modal
                document.getElementById('modalClientName').textContent = `Detalles de ${data.client.name}`;
                
                // Calcular "hace X d√≠as" para √∫ltima sesi√≥n
                let lastSessionText = 'No hay sesiones registradas';
                if (data.last_session_days !== null) {
                    if (data.last_session_days === 0) {
                        lastSessionText = 'Hoy';
                    } else if (data.last_session_days === 1) {
                        lastSessionText = 'Hace 1 d√≠a';
                    } else {
                        lastSessionText = `Hace ${data.last_session_days} d√≠as`;
                    }
                }
                
                // Construir HTML del contenido
                const modalContent = `
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold;">
                            ${data.client.name.charAt(0).toUpperCase()}
                        </div>
                        <h3 style="margin: 0; font-size: 20px; color: #333;">${data.client.name}</h3>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">${data.client.email}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600; color: #333;">Progreso actual:</span>
                            <span style="font-size: 18px; font-weight: bold; color: #667eea;">${data.progress}%</span>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${data.progress}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üìÖ</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">√öltima sesi√≥n:</div>
                                <div style="font-weight: 600; color: #333;">${lastSessionText}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üóìÔ∏è</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Pr√≥xima cita:</div>
                                <div style="font-weight: 600; color: #333;">${data.next_appointment || 'No programada'}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">üìä</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Estado:</div>
                                <div style="font-weight: 600; color: ${data.status === 'Activo' ? '#28a745' : '#dc3545'};">${data.status}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="font-size: 24px; margin-right: 12px;">‚úÖ</span>
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Sesiones completadas:</div>
                                <div style="font-weight: 600; color: #333;">${data.completed_sessions} de ${data.total_sessions}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContent').innerHTML = modalContent;
            } else {
                document.getElementById('modalContent').innerHTML = `
                    <div style="text-align: center; padding: 40px 0; color: #dc3545;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p>Error al cargar los datos del cliente</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('modalContent').innerHTML = `
                <div style="text-align: center; padding: 40px 0; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                    <p>Error de conexi√≥n. Por favor, intenta de nuevo.</p>
                </div>
            `;
        });
}

function closeModal() {
    document.getElementById('clientModal').style.display = 'none';
}

// Cerrar modal al hacer click fuera de √©l
window.onclick = function(event) {
    const modal = document.getElementById('clientModal');
    if (event.target == modal) {
        closeModal();
    }
}

// EJECUTAR INMEDIATAMENTE al final del documento para establecer barras de progreso
(function() {
    document.querySelectorAll('.student-card .progress-bar').forEach(bar => {
        const progress = bar.getAttribute('data-progress');
        if (progress) {
            bar.style.setProperty('width', progress + '%', 'important');
        }
    });
    
    // Funci√≥n para actualizar datos de un cliente espec√≠fico
    window.updateClientData = function(clientId) {
        fetch(`/api/client/${clientId}/details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cards = document.querySelectorAll('.student-card');
                    cards.forEach(card => {
                        const verBtn = card.querySelector('[onclick*="verDetalleCliente"]');
                        if (verBtn) {
                            const onclickStr = verBtn.getAttribute('onclick');
                            const match = onclickStr.match(/verDetalleCliente\((\d+)\)/);
                            if (match && match[1] == clientId) {
                                const progressBar = card.querySelector('.progress-bar');
                                const progressText = card.querySelectorAll('.progress-section span')[1];
                                if (progressBar) {
                                    progressBar.setAttribute('data-progress', data.progress);
                                    progressBar.style.setProperty('width', data.progress + '%', 'important');
                                }
                                if (progressText) progressText.textContent = data.progress + '%';
                                const sessionInfo = card.querySelector('div[style*="Sesiones"]');
                                if (sessionInfo) sessionInfo.innerHTML = `üìÖ Sesiones: ${data.completed_sessions}/${data.total_sessions}`;
                            }
                        }
                    });
                }
            })
            .catch(err => console.error('Error:', err));
    };
    
    // Verificar si hay un cliente que necesita actualizarse desde localStorage
    const clientUpdated = localStorage.getItem('clientUpdated');
    if (clientUpdated) {
        console.log('Cliente marcado para actualizar:', clientUpdated);
        localStorage.removeItem('clientUpdated');
        setTimeout(() => window.updateClientData(clientUpdated), 500);
    }
})();
</script>
{% endblock %}
